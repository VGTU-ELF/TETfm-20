<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Asciidoctor 1.5.4">
  <title>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Vilniaus Gedimino
    technikos universitetas</title>
  <link rel="stylesheet" href="https://asciidoclive.com/assets/asciidoctor.js/css/asciidoctor.css">
</head>

<body class="article">
  <div id="header">
    <h1>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Vilniaus Gedimino
      technikos universitetas</h1>
  </div>
  <div id="content">
    <div class="sect1 text-center">
      <h2 id="_elektronikos_fakultetas">Elektronikos fakultetas</h2>
      <div class="sectionbody">
        <div class="sect2">
          <h3 id="_kompiuterijos_ir_ry_i_technologij_katedra">Kompiuterijos ir ryšių technologijų katedra</h3>
          <div class="paragraph">
            <p>&#160;</p>
          </div>
          <div class="paragraph">
            <p>&#160;</p>
          </div>
          <div class="paragraph">
            <p>&#160;</p>
          </div>
          <div class="paragraph">
            <p>&#160;</p>
          </div>
          <div class="paragraph">
            <p>&#160;</p>
          </div>
          <div class="paragraph">
            <p>&#160;</p>
          </div>
        </div>
        <div class="sect2">
          <h3 id="_debes_kompiuterija">Debesų kompiuterija</h3>
          <div class="paragraph">
            <p>Modulis ELKRM17304</p>
          </div>
        </div>
      </div>
    </div>
    <div class="sect1 text-center">
      <h2 id="__em_docker_swarm_em_klasterio_diegimas_ir_tyrimas"><em>Docker Swarm</em> klasterio įdiegimas ir tyrimas</h2>
      <div class="sectionbody">
        <div class="paragraph">
          <p>Kursinis darbas</p>
        </div>
        <div class="paragraph">
          <p>&#160;</p>
        </div>
        <div class="paragraph">
          <p>&#160;</p>
        </div>
        <div class="paragraph">
          <p>&#160;</p>
        </div>
        <div class="paragraph">
          <p>&#160;</p>
        </div>
        <div class="paragraph">
          <p>&#160;</p>
        </div>
        <div class="paragraph text-right">
          <p><strong>Atliko:</strong> TETfm-20 grupės magistrantas<br> Saulius Krasuckas<br>
            <strong>Tikrino:</strong> lekt. dr. Liudas Duoba</p>
        </div>
        <div class="paragraph">
          <p>&#160;</p>
        </div>
        <div class="paragraph">
          <p>&#160;</p>
        </div>
        <div class="paragraph">
          <p>&#160;</p>
        </div>
        <div class="paragraph">
          <p>&#160;</p>
        </div>
        <div class="paragraph">
          <p>&#160;</p>
        </div>
        <div class="paragraph">
          <p>&#160;</p>
        </div>
        <div class="paragraph">
          <p>VILNIUS, 2022</p>
        </div>
        <div style="page-break-after: always;"></div>
        <div class="paragraph">
          <p>&#160;</p>
        </div>
        <div class="sect3 text-center">
          <h4 id="_kursinis_darbas">Kursinis darbas</h4>

        </div>
      </div>
    </div>
    <div class="sect1 text-center">
      <h2 id="__em_docker_swarm_em_klasterio_diegimas_ir_tyrimas_2"><em>Docker Swarm</em> klasterio įdiegimas ir tyrimas</h2>
      <div class="sectionbody">
        <div class="paragraph">
          <p>&#160;</p>
        </div>
        <div class="sect2">
          <h3 id="_1_kursinio_darbo_u_duotis">1. Kursinio darbo užduotis</h3>
          <div class="paragraph">
            <p>&#160;</p>
          </div>
          <div class="ulist text-left">
            <ul>
              <li>
                <p>Savarankiškai išstudijuoti <em>Docker Swarm</em> veikimo principus,
                  juos aprašyti</p>
              </li>
              <li>
                <p>Sukonfigūruoti <em>Docker Swarm</em> klasterį, kurį sudaro ne mažiau
                  trijų kompiuterių / virtualių mašinų (VM)</p>
              </li>
              <li>
                <p>Atvaizduoti klasterio konfigūraciją grafiškai (pateikti schemas)</p>
              </li>
              <li>
                <p>Klasteryje paleisti <em>Web</em>-servisą, veikiantį konteinerių pagrindu.
                  Servisas turi būti pasiekiamas.</p>
              </li>
              <li>
                <p>Sukurti ne mažiau kaip 3 serviso kopijas (replikas). Parodyti, kaip
                  servisai pasiskirsto klasteryje.</p>
              </li>
              <li>
                <p>Imituoti vieno iš klasterio elementų gedimą; aprašyti / parodyti
                  poveikį servisams.</p>
              </li>
              <li>
                <p>Parodyti / atvaizduoti <em>Web</em>-serviso pasiekiamumą visuose
                  etapuose.</p>
              </li>
              <li>
                <p>Pateikti naudojamas komandas</p>
              </li>
            </ul>
          </div>
          <div class="paragraph">
            <p>&#160;</p>
          </div>
        </div>
        <div class="sect2">
          <h3 id="_2_pagrindin_dalis">2. Pagrindinė dalis</h3>
          <div class="paragraph">
            <p>&#160;</p>
          </div>
          <div class="sect3 text-left">
            <h4 id="__em_docker_swarm_em_veikimo_principai"><em>Docker Swarm</em> veikimo principai</h4>
            <div class="olist arabic">
              <ol class="arabic">
                <li>
                  <p>Nuo versijos 1.12 <em>Swarm mode</em> mechanizmas buvo integruotas
                    į Docker CLI tiesiogiai. <a href="#4">[4]</a><br> Anksčiau jis
                    reikalaudavo papildomų konteinerių kūrimo ir vadinosi <em>Classic Swarm</em>.</p>
                </li>
                <li>
                  <p>Mechanizmas įgalina skirstyti konteinerius tarp daugelio Docker
                    hostų.</p>
                </li>
                <li>
                  <p>Tam naudojamas <em>Overlay</em> tipo tinklas su <em>Mesh routing</em>                    technlogija.</p>
                </li>
                <li>
                  <p>Jis leidžia apjungti hostus į vieną tinklą ir įgalina jame atlikti
                    servisų <em>Discovery</em> ir <em>Load</em>-balansavimą.</p>
                </li>
                <li>
                  <p>Konteinerių idėją papildo trys nauji konceptai:</p>
                  <div class="olist loweralpha">
                    <ol class="loweralpha" type="a">
                      <li>
                        <p><strong>Mazgas</strong> (angl. <em>Node</em>)&#8201;&#8212;&#8201;tai
                          atskiras Docker variklio egzempliorius (hostas), prijungtas
                          prie <em>Swarm</em> klasterio. <br> Mazgai būna arba <em>Worker</em>                          tipo, arba <em>Manager</em> tipo:</p>
                        <div class="ulist">
                          <ul>
                            <li>
                              <p><em>Manager</em> dėlioja, kur koks konteineris veiks.</p>
                            </li>
                            <li>
                              <p><em>Worker</em> tiesiog tuos konteinerius vykdo.</p>
                            </li>
                            <li>
                              <p>Taipogi <em>Manager</em> tipo mazgas gali būti ir <em>Worker</em>                                mazgu.</p>
                            </li>
                          </ul>
                        </div>
                      </li>
                      <li>
                        <p><strong>Servisas</strong> (angl. <em>Service</em>)&#8201;&#8212;&#8201;abstraktesnis
                          konceptas, siejantis grupę užduočių, kurias turėtų vykdyti
                          <em>Workers</em> tam, kad pasiektų integralų rezultatą.</p>
                      </li>
                      <li>
                        <p><strong>Apkrovos balansavimas</strong> (angl. <em>Load Balancing</em>)&#8201;&#8212;&#8201;tai
                          užklausų, ateinančių į bet kurį <em>Swarm</em> mazgą paskirstymas
                          į konteinerius, vykdančius atitinkamą paslaugą.</p>
                      </li>
                    </ol>
                  </div>
                </li>
                <li>
                  <p><em>Overlay</em> tinklas. <br> Tai <code>VxLAN</code> technologija
                    grįsta tinklo architektūra, leidžianti apimti skirtinguose debesyse
                    ir duomenų centruose veikiančius Docker hostus. <br> Veikimui
                    naudojamas <em>Routing Mesh</em>, <em>Virtual IP</em> ir <em>Linux IPVS</em>&#8201;&#8212;&#8201;multiprotokolinis
                    (Layer-4) apkrovos balansavimo mechanizmas.</p>
                </li>
              </ol>
            </div>
            <div class="paragraph">
              <p>&#160;</p>
            </div>
          </div>
          <div class="sect3 text-left">
            <h4 id="__em_docker_swarm_em_klasterio_konfig_ravimas"><em>Docker Swarm</em> klasterio konfigūravimas</h4>
            <div class="olist arabic">
              <ol class="arabic">
                <li>
                  <p>Infrastruktūrai kuri pasirinkau namie turimą nešiojamąjį kompiuterį
                    su Windows OS.</p>
                </li>
                <li>
                  <p>Jame įsidiegiau VirtualBox VMM (arba hipervizorių).</p>
                </li>
                <li>
                  <p>Kaip <em>Guest OS</em> pasirinkau 64-bit <strong>Ubuntu 20.04.3 LTS</strong>                    Linux distribuciją.</p>
                </li>
                <li>
                  <p>Pasinaudojau <code>OSboxes.org</code> projekto teikiamu įdiegtos
                    OS atvaizdžiu. <a href="#1">[1]</a></p>
                </li>
                <li>
                  <p>VM kūrimui ir valdymui pasirinkau VirtualBox CLI <code>VBoxManage</code>                    ir MSYS2 įrankį, kuris Windows OS suteikia <em>*nix</em> tipo
                    aplinką.</p>
                </li>
                <li>
                  <p>Čia susikūriau kelis <em>Bash</em> skriptus:</p>
                  <div class="ulist">
                    <ul>
                      <li>
                        <p><a href="https://github.com/VGTU-ELF/TETfm-20/tree/main/Semestras-3/2-Debes%C5%B3-kompiuterija/kursinis-darbas/Saulius-Krasuckas#:~:text=build%2Dinfra.sh,ubuntu%2Dhostnames.sh"><code>build-infra.sh</code></a>                          (<em>Golden image</em> ir atskirų VM formavimui)</p>
                      </li>
                      <li>
                        <p><a href="https://github.com/VGTU-ELF/TETfm-20/blob/main/Semestras-3/2-Debes%C5%B3-kompiuterija/kursinis-darbas/Saulius-Krasuckas/setup-osboxes-ubuntu-20.04.sh"><code>setup-osboxes-ubuntu-20.04.sh</code></a>                          (VM tvarkymo eiga)</p>
                      </li>
                      <li>
                        <p><a href="https://github.com/VGTU-ELF/TETfm-20/blob/main/Semestras-3/2-Debes%C5%B3-kompiuterija/kursinis-darbas/Saulius-Krasuckas/osboxes-ubuntu-20.04-changes.sh"><code>osboxes-ubuntu-20.04-changes.sh</code></a>                          (pagrindiniai Guest OS tvarkymo veiksmai)</p>
                      </li>
                      <li>
                        <p><a href="https://github.com/VGTU-ELF/TETfm-20/blob/main/Semestras-3/2-Debes%C5%B3-kompiuterija/kursinis-darbas/Saulius-Krasuckas/setup-ubuntu-docker.sh"><code>setup-ubuntu-docker.sh</code></a>                          (<em>Docker</em> įdiegimas)</p>
                      </li>
                      <li>
                        <p><a href="https://github.com/VGTU-ELF/TETfm-20/blob/main/Semestras-3/2-Debes%C5%B3-kompiuterija/kursinis-darbas/Saulius-Krasuckas/setup-ubuntu-hostnames.sh"><code>setup-ubuntu-hostnames.sh</code></a>                          (individualizuotų mazgo vardų tvarkymas)</p>
                      </li>
                      <li>
                        <p>Skriptų naudojimo privalumas&#8201;&#8212;&#8201;lengva turėti
                          kad ir 20 identiškų virtualių mašinų.
                          <br> O padarius konfigūravimo klaidą, lengva ją pataisyti
                          ir visą infrastruktūrą susikurti iš naujo.</p>
                      </li>
                    </ul>
                  </div>
                </li>
                <li>
                  <p>Startavus <code>build-infra.sh</code>:</p>
                  <div class="ulist">
                    <ul>
                      <li>
                        <p>Parsisiunčiamas <code>Ubuntu 20.04.3 (64bit).vdi</code> atvaizdis.</p>
                      </li>
                      <li>
                        <p>Jo pagrindu sukuriama etaloninė VM.</p>
                      </li>
                      <li>
                        <p>Ji startuojama, ir atliekami pagrindiniai OS tvarkymo veiksmai
                          (SSH raktų tvarkymas, <code>sudo</code> perkonfigūravimas,
                          naujinimai, paketų diegimas, perkrovimas, Docker diegimas).</p>
                      </li>
                      <li>
                        <p>VM išjungiama, o disko atvaizdis paruošiamas jungimui prie
                          keleto mašinų (angl. <em>Multi-attach</em>).</p>
                      </li>
                      <li>
                        <p>Sukuriamos trys VM pagal bendrą šabloną:</p>
                        <div class="ulist">
                          <ul>
                            <li>
                              <p>1 GiB RAM, 2 CPU.</p>
                            </li>
                            <li>
                              <p>1 NIC išėjimui į internetą (angl. <em>Default route</em>);</p>
                            </li>
                            <li>
                              <p>1 NIC Docker klasterio ryšiui (<em>App</em>);</p>
                            </li>
                            <li>
                              <p>1 NIC OAM ryšiui (angl. <em>Operation, Administration, Maintenance</em>).</p>
                            </li>
                            <li>
                              <p>Visi NIC gauna adresus iš VBox integruoto DHCP serviso.</p>
                            </li>
                            <li>
                              <p>Kiekvienai VM nustatomas OAM IP adresas.</p>
                            </li>
                            <li>
                              <p>Prie jo prisijungiama automatiškai.</p>
                            </li>
                            <li>
                              <p><code>/etc/hosts</code> faile užregistruojami suteikti
                                IP adresai ir mazgo vardai.</p>
                            </li>
                            <li>
                              <p>Tuomet šie duomenys surenkami į bendrą failą ir padalinimi
                                į visus Guest OS iš eilės.</p>
                            </li>
                            <li>
                              <p>Taip pat patvirtinami SSH ECDSA raktai tarp skirtingų
                                mazgų.</p>
                            </li>
                          </ul>
                        </div>
                      </li>
                      <li>
                        <p>Trys VM paruoštos darbui.</p>
                      </li>
                      <li>
                        <p>Išskyrus atvaizdžio siuntimo laiką, paruošimas trunka apie
                          65 min.</p>
                      </li>
                    </ul>
                  </div>
                </li>
                <li>
                  <p>Rankiniu būdu konfigūruoju <em>Docker Swarm mode</em> klasterį
                    pagal Docker dokumentacijos pamoką: <a href="#2">[2]</a></p>
                  <div class="paragraph">
                    <p>Patikrinimas:</p>
                  </div>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker info | grep --color -e Swarm: -e CPUs: -e Total.Memory:
 Swarm: inactive
 CPUs: 2
 Total Memory: 971.2MiB</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>Pirmas bandymas startuoti <em>Swarm</em> klasterį:</p>
                  </div>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker swarm init
Error response from daemon: could not choose an IP address to advertise since this system has multiple addresses on different interfaces (10.0.2.15 on enp0s3 and 10.1.1.24 on enp0s8) - specify one with --advertise-addr</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>Bandau nurodyti klasterio ryšio adresą kaip mazgo vardą:</p>
                  </div>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker swarm init --advertise-addr swarm-n01
Error response from daemon: advertise address must be a non-zero IP address or network interface (with optional port number)</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>Netiko. Pateikus interfeiso vardą tiko:</p>
                  </div>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker swarm init --advertise-addr enp0s8
Swarm initialized: current node (l6wnnbsgv2th6nq05e9j02srj) is now a manager.

To add a worker to this swarm, run the following command:

    docker swarm join --token SWMTKN-1-40jfoeoj9kgwtcqbtc9klrwaeoh8ogfebxoa8r1euzxnzfe7ha-ee278x6iuxb6ny7g4v34z9phw 10.1.1.24:2377

To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>Tikrinu būseną:</p>
                  </div>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker info | grep --color -e ^ -e Swarm
  ...
 Swarm: active
  NodeID: l6wnnbsgv2th6nq05e9j02srj
  Is Manager: true
  ClusterID: tbmszwsuuyydpgzw90lsblvjd
  Managers: 1
  Nodes: 1
  Default Address Pool: 10.0.0.0/8
  SubnetSize: 24
  Data Path Port: 4789
  Orchestration:
   Task History Retention Limit: 5
  Raft:
   Snapshot Interval: 10000
   Number of Old Snapshots to Retain: 0
   Heartbeat Tick: 1
   Election Tick: 10
  Dispatcher:
   Heartbeat Period: 5 seconds
  CA Configuration:
   Expiry Duration: 3 months
   Force Rotate: 0
  Autolock Managers: false
  Root Rotation In Progress: false
  Node Address: 10.1.1.24
  Manager Addresses:
   10.1.1.24:2377
  ...</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>Sutikrinu su interfeisų IP adresais:</p>
                  </div>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:7e:2a:d2 brd ff:ff:ff:ff:ff:ff
    inet 10.0.2.15/24 brd 10.0.2.255 scope global dynamic noprefixroute enp0s3
       valid_lft 85952sec preferred_lft 85952sec
    inet6 fe80::72a6:ed0b:5033:2f37/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
3: enp0s8: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:f0:5c:76 brd ff:ff:ff:ff:ff:ff
    inet 10.1.1.24/24 brd 10.1.1.255 scope global dynamic noprefixroute enp0s8
       valid_lft 453sec preferred_lft 453sec
    inet6 fe80::1d12:9739:5544:643a/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
4: enp0s9: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:57:72:bd brd ff:ff:ff:ff:ff:ff
    inet 192.168.56.101/24 brd 192.168.56.255 scope global dynamic noprefixroute enp0s9
       valid_lft 453sec preferred_lft 453sec
    inet6 fe80::e076:cc40:af50:5f45/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
5: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default
    link/ether 02:42:2f:74:cc:6f brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
       valid_lft forever preferred_lft forever
10: docker_gwbridge: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default
    link/ether 02:42:2c:42:48:68 brd ff:ff:ff:ff:ff:ff
    inet 172.18.0.1/16 brd 172.18.255.255 scope global docker_gwbridge
       valid_lft forever preferred_lft forever
    inet6 fe80::42:2cff:fe42:4868/64 scope link
       valid_lft forever preferred_lft forever
12: vethb5ec981@if11: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker_gwbridge state UP group default
    link/ether 06:3e:2a:e4:2c:55 brd ff:ff:ff:ff:ff:ff link-netnsid 1
    inet6 fe80::43e:2aff:fee4:2c55/64 scope link
       valid_lft forever preferred_lft forever</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>Atitinka <code>enp0s8</code>. Tikrinu mazgų sąrašą:</p>
                  </div>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker node ls
ID                            HOSTNAME    STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
l6wnnbsgv2th6nq05e9j02srj *   swarm-n01   Ready     Active         Leader           20.10.12</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>Prijungiu antrą mazgą:</p>
                  </div>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n02-oam sudo docker swarm join --token SWMTKN-1-40jfoeoj9kgwtcqbtc9klrwaeoh8ogfebxoa8r1euzxnzfe7ha-ee278x6iuxb6ny7g4v34z9phw 10.1.1.24:2377
This node joined a swarm as a worker.</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>Tikrinu mazgų sąrašą:</p>
                  </div>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker node ls
ID                            HOSTNAME    STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
l6wnnbsgv2th6nq05e9j02srj *   swarm-n01   Ready     Active         Leader           20.10.12
a50ddvlva40nzzvtxu1hpsus7     swarm-n02   Ready     Active                          20.10.12</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>Prijungiu trečią narį:</p>
                  </div>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n03-oam sudo docker swarm join --token SWMTKN-1-40jfoeoj9kgwtcqbtc9klrwaeoh8ogfebxoa8r1euzxnzfe7ha-ee278x6iuxb6ny7g4v34z9phw 10.1.1.24:2377
This node joined a swarm as a worker.</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>Patikrinu, jau visi trys klasteryje:</p>
                  </div>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker node ls
ID                            HOSTNAME    STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
l6wnnbsgv2th6nq05e9j02srj *   swarm-n01   Ready     Active         Leader           20.10.12
a50ddvlva40nzzvtxu1hpsus7     swarm-n02   Ready     Active                          20.10.12
6qeivl6aatpwxb50vi8hpr4bh     swarm-n03   Ready     Active                          20.10.12</pre>
                    </div>
                  </div>
                </li>
              </ol>
            </div>
            <div class="paragraph">
              <p>&#160;</p>
            </div>
          </div>
          <div class="sect3 text-left">
            <h4 id="_klasterio_konfig_racija">Klasterio konfigūracija</h4>
            <div class="imageblock">
              <div class="content">
                <img src="https://raw.githubusercontent.com/VGTU-ELF/TETfm-20/main/Semestras-3/2-Debes%C5%B3-kompiuterija/kursinis-darbas/Saulius-Krasuckas/img/Docker-Swarm-klasterio-konfig%C5%ABracija.svg"
                  alt="Docker Swarm klasterio konfig%C5%ABracija" width="100%">
              </div>
              <div class="title">Figure 1. (1 pav.) Klasterio mazgų konfigūracija tarpusavyje ir Host
                OS atžvilgiu.</div>
            </div>
            <div class="paragraph">
              <p>&#160;</p>
            </div>
          </div>
          <div class="sect3 text-left">
            <h4 id="__em_web_em_serviso_startavimas_ir_tikrinimas"><em>Web</em>-serviso startavimas ir tikrinimas</h4>
            <div class="olist arabic">
              <ol class="arabic">
                <li>
                  <p>Iš visos galybės pasirenku <em>Web</em>-servisą, matytą <em>KataCoda</em>                    puslapio treniruotėse: <code>katacoda/docker-http-server</code>.
                    <a href="#3">[3]</a><br> Ir startuoju pavienį konteinerį su juo:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker run -d --name http-band -p 80:80 katacoda/docker-http-server
Unable to find image 'katacoda/docker-http-server:latest' locally
latest: Pulling from katacoda/docker-http-server
f139eb4721ae: Pulling fs layer
f139eb4721ae: Verifying Checksum
f139eb4721ae: Download complete
f139eb4721ae: Pull complete
Digest: sha256:76dc8a47fd019f80f2a3163aba789faf55b41b2fb06397653610c754cb12d3ee
Status: Downloaded newer image for katacoda/docker-http-server:latest
84f32317148cac3ea8dfffb6587258f905d8563064302b7fc457d35156dd4240</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Tikrinu, konteineris veikia:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker ps
CONTAINER ID   IMAGE                         COMMAND   CREATED          STATUS          PORTS                               NAMES
84f32317148c   katacoda/docker-http-server   "/app"    20 seconds ago   Up 19 seconds   0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp   http-band</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Tikrinu su lokaliu http-klientu, veikia:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam curl -s localhost
&lt;h1&gt;This request was processed by host: 84f32317148c&lt;/h1&gt;</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Ištrinu bandomąjį konteinerį:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker stop http-band
http-band

$ ssh swarm-n01-oam sudo docker rm http-band
http-band</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Pagal jo atvaizdį kuriu jau ne pavienį, o klasterinį <em>Web</em>-servisą
                    <code>kursinis-web-service</code>:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker service create --name kursinis-web-service -p 80:80 katacoda/docker-http-server
p7imsxwi9midpu5b378srq54w
overall progress: 0 out of 1 tasks
1/1:
overall progress: 0 out of 1 tasks
overall progress: 0 out of 1 tasks
overall progress: 0 out of 1 tasks
overall progress: 0 out of 1 tasks
overall progress: 0 out of 1 tasks
overall progress: 0 out of 1 tasks
overall progress: 0 out of 1 tasks
overall progress: 0 out of 1 tasks
overall progress: 1 out of 1 tasks
verify: Waiting 5 seconds to verify that tasks are stable...
verify: Waiting 5 seconds to verify that tasks are stable...
verify: Waiting 5 seconds to verify that tasks are stable...
verify: Waiting 5 seconds to verify that tasks are stable...
verify: Waiting 5 seconds to verify that tasks are stable...
verify: Waiting 4 seconds to verify that tasks are stable...
verify: Waiting 4 seconds to verify that tasks are stable...
verify: Waiting 4 seconds to verify that tasks are stable...
verify: Waiting 4 seconds to verify that tasks are stable...
verify: Waiting 3 seconds to verify that tasks are stable...
verify: Waiting 3 seconds to verify that tasks are stable...
verify: Waiting 3 seconds to verify that tasks are stable...
verify: Waiting 3 seconds to verify that tasks are stable...
verify: Waiting 3 seconds to verify that tasks are stable...
verify: Waiting 2 seconds to verify that tasks are stable...
verify: Waiting 2 seconds to verify that tasks are stable...
verify: Waiting 2 seconds to verify that tasks are stable...
verify: Waiting 2 seconds to verify that tasks are stable...
verify: Waiting 1 seconds to verify that tasks are stable...
verify: Waiting 1 seconds to verify that tasks are stable...
verify: Waiting 1 seconds to verify that tasks are stable...
verify: Waiting 1 seconds to verify that tasks are stable...
verify: Service converged</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Klasterinių servisų sąrašas:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker service ls
ID             NAME                   MODE         REPLICAS   IMAGE                                PORTS
p7imsxwi9mid   kursinis-web-service   replicated   1/1        katacoda/docker-http-server:latest   *:80-&gt;80/tcp</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>Veikia, naudoja tik 1 repliką (pagal nutylėjimą).</p>
                  </div>
                </li>
                <li>
                  <p>Tikrinu servisą lokaliai:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam curl -s localhost
&lt;h1&gt;This request was processed by host: 9c2d26cbff9e&lt;/h1&gt;</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Patikrinu lokalių konteinerių būseną pirmame mazge, veikia lygiai
                    vienas:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker ps
CONTAINER ID   IMAGE                                COMMAND   CREATED          STATUS          PORTS     NAMES
9c2d26cbff9e   katacoda/docker-http-server:latest   "/app"    34 seconds ago   Up 32 seconds   80/tcp    kursinis-web-service.1.vekfptu7x3egid5me161x4gbj</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Serviso pasiekiamumas mazguose:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker service ps kursinis-web-service
ID             NAME                     IMAGE                                NODE        DESIRED STATE   CURRENT STATE                ERROR     PORTS
vekfptu7x3eg   kursinis-web-service.1   katacoda/docker-http-server:latest   swarm-n01   Running         Running about a minute ago</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>Kol kas veikia tik viename mazge.</p>
                  </div>
                </li>
                <li>
                  <p>Detalus serviso inspektavimas:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker service inspect kursinis-web-service
[
    {
        "ID": "p7imsxwi9midpu5b378srq54w",
        "Version": {
            "Index": 23
        },
        "CreatedAt": "2022-02-09T09:48:19.22071502Z",
        "UpdatedAt": "2022-02-09T09:48:19.226648699Z",
        "Spec": {
            "Name": "kursinis-web-service",
            "Labels": {},
            "TaskTemplate": {
                "ContainerSpec": {
                    "Image": "katacoda/docker-http-server:latest@sha256:76dc8a47fd019f80f2a3163aba789faf55b41b2fb06397653610c754cb12d3ee",
                    "Init": false,
                    "StopGracePeriod": 10000000000,
                    "DNSConfig": {},
                    "Isolation": "default"
                },
                "Resources": {
                    "Limits": {},
                    "Reservations": {}
                },
                "RestartPolicy": {
                    "Condition": "any",
                    "Delay": 5000000000,
                    "MaxAttempts": 0
                },
                "Placement": {
                    "Platforms": [
                        {
                            "Architecture": "amd64",
                            "OS": "linux"
                        }
                    ]
                },
                "ForceUpdate": 0,
                "Runtime": "container"
            },
            "Mode": {
                "Replicated": {
                    "Replicas": 1
                }
            },
            "UpdateConfig": {
                "Parallelism": 1,
                "FailureAction": "pause",
                "Monitor": 5000000000,
                "MaxFailureRatio": 0,
                "Order": "stop-first"
            },
            "RollbackConfig": {
                "Parallelism": 1,
                "FailureAction": "pause",
                "Monitor": 5000000000,
                "MaxFailureRatio": 0,
                "Order": "stop-first"
            },
            "EndpointSpec": {
                "Mode": "vip",
                "Ports": [
                    {
                        "Protocol": "tcp",
                        "TargetPort": 80,
                        "PublishedPort": 80,
                        "PublishMode": "ingress"
                    }
                ]
            }
        },
        "Endpoint": {
            "Spec": {
                "Mode": "vip",
                "Ports": [
                    {
                        "Protocol": "tcp",
                        "TargetPort": 80,
                        "PublishedPort": 80,
                        "PublishMode": "ingress"
                    }
                ]
            },
            "Ports": [
                {
                    "Protocol": "tcp",
                    "TargetPort": 80,
                    "PublishedPort": 80,
                    "PublishMode": "ingress"
                }
            ],
            "VirtualIPs": [
                {
                    "NetworkID": "vpyp1hp7w63i40yltmydhwl8o",
                    "Addr": "10.0.0.5/24"
                }
            ]
        }
    }
]</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Malonesnis skaitymui serviso būsenos pavidalas:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker service inspect --pretty kursinis-web-service

ID:             p7imsxwi9midpu5b378srq54w
Name:           kursinis-web-service
Service Mode:   Replicated
 Replicas:      1
Placement:
UpdateConfig:
 Parallelism:   1
 On failure:    pause
 Monitoring Period: 5s
 Max failure ratio: 0
 Update order:      stop-first
RollbackConfig:
 Parallelism:   1
 On failure:    pause
 Monitoring Period: 5s
 Max failure ratio: 0
 Rollback order:    stop-first
ContainerSpec:
 Image:         katacoda/docker-http-server:latest@sha256:76dc8a47fd019f80f2a3163aba789faf55b41b2fb06397653610c754cb12d3ee
 Init:          false
Resources:
Endpoint Mode:  vip
Ports:
 PublishedPort = 80
  Protocol = tcp
  TargetPort = 80
  PublishMode = ingress</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Servisas lyg veikia. Tačiau tarp įprastų <em>Listening</em> TCP
                    soketų <code>80/TCP</code> nesimato:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam ss -4nl
Netid  State   Recv-Q  Send-Q   Local Address:Port    Peer Address:Port Process
udp    UNCONN  0       0        127.0.0.53%lo:53           0.0.0.0:*
udp    UNCONN  0       0              0.0.0.0:631          0.0.0.0:*
udp    UNCONN  0       0              0.0.0.0:4789         0.0.0.0:*
udp    UNCONN  0       0              0.0.0.0:5353         0.0.0.0:*
udp    UNCONN  0       0              0.0.0.0:59148        0.0.0.0:*
tcp    LISTEN  0       4096     127.0.0.53%lo:53           0.0.0.0:*
tcp    LISTEN  0       128            0.0.0.0:22           0.0.0.0:*
tcp    LISTEN  0       5            127.0.0.1:631          0.0.0.0:*</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Nuimu <em>tik</em> IPv4 rodymą ir tikrinu iš naujo:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n02-oam sudo ss -nlp | grep :80
tcp    LISTEN  0        4096                                                  *:80                                                     *:*                       users:(("dockerd",pid=693,fd=25))</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>&#8658; Matyti, jog mano serviso TCP soketą aptarnauja procesas
                      <code>docker</code>.</p>
                  </div>
                </li>
                <li>
                  <p>Peržiūriu tinklo interfeisų sąrašą:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:7e:2a:d2 brd ff:ff:ff:ff:ff:ff
    inet 10.0.2.15/24 brd 10.0.2.255 scope global dynamic noprefixroute enp0s3
       valid_lft 82807sec preferred_lft 82807sec
    inet6 fe80::72a6:ed0b:5033:2f37/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
3: enp0s8: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:f0:5c:76 brd ff:ff:ff:ff:ff:ff
    inet 10.1.1.24/24 brd 10.1.1.255 scope global dynamic noprefixroute enp0s8
       valid_lft 307sec preferred_lft 307sec
    inet6 fe80::1d12:9739:5544:643a/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
4: enp0s9: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:57:72:bd brd ff:ff:ff:ff:ff:ff
    inet 192.168.56.101/24 brd 192.168.56.255 scope global dynamic noprefixroute enp0s9
       valid_lft 307sec preferred_lft 307sec
    inet6 fe80::e076:cc40:af50:5f45/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
5: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default
    link/ether 02:42:2f:74:cc:6f brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
       valid_lft forever preferred_lft forever
    inet6 fe80::42:2fff:fe74:cc6f/64 scope link
       valid_lft forever preferred_lft forever
10: docker_gwbridge: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default
    link/ether 02:42:2c:42:48:68 brd ff:ff:ff:ff:ff:ff
    inet 172.18.0.1/16 brd 172.18.255.255 scope global docker_gwbridge
       valid_lft forever preferred_lft forever
    inet6 fe80::42:2cff:fe42:4868/64 scope link
       valid_lft forever preferred_lft forever
12: vethb5ec981@if11: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker_gwbridge state UP group default
    link/ether 06:3e:2a:e4:2c:55 brd ff:ff:ff:ff:ff:ff link-netnsid 1
    inet6 fe80::43e:2aff:fee4:2c55/64 scope link
       valid_lft forever preferred_lft forever
24: veth3505fba@if23: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker_gwbridge state UP group default
    link/ether 86:1b:0d:15:e5:7b brd ff:ff:ff:ff:ff:ff link-netnsid 2
    inet6 fe80::841b:dff:fe15:e57b/64 scope link
       valid_lft forever preferred_lft forever</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>Dabar jis pasipildė dar vienu: <code>veth*@if23</code> <br></p>
                  </div>
                </li>
                <li>
                  <p>Patikrinu serviso pasiekiamumą lokaliai kreipiantis ne į Docker
                    skirtą sisteminį tinklo interfeisą <code>enp0s8</code>, bet į
                    OAM dedikuotą interfeisą <code>enp0s9</code> su visai kitu IP
                    adresu:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam ping 192.168.56.101
PING 192.168.56.101 (192.168.56.101) 56(84) bytes of data.
64 bytes from 192.168.56.101: icmp_seq=1 ttl=64 time=0.051 ms
64 bytes from 192.168.56.101: icmp_seq=2 ttl=64 time=0.083 ms

$ ssh swarm-n01-oam curl -s 192.168.56.101
&lt;h1&gt;This request was processed by host: 9c2d26cbff9e&lt;/h1&gt;</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>Atsakymą iš serviso vis tiek gaunu. Kiek netikėta ir malonu.</p>
                  </div>
                </li>
                <li>
                  <p>Taip pat tikrinu serviso pasiekiamumą OAM interfeisu ir išorėje,
                    ne tik lokaliai:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ curl -s 192.168.56.101
&lt;h1&gt;This request was processed by host: 9c2d26cbff9e&lt;/h1&gt;

$ curl -s 192.168.56.101
&lt;h1&gt;This request was processed by host: 9c2d26cbff9e&lt;/h1&gt;

$ curl -s 192.168.56.101
&lt;h1&gt;This request was processed by host: 9c2d26cbff9e&lt;/h1&gt;</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>&#8658; Servisas atsiliepia ir Host OSe veikiančiam http-klientui.
                      Puiku.</p>
                  </div>
                </li>
              </ol>
            </div>
            <div class="paragraph">
              <p>&#160;</p>
            </div>
          </div>
          <div class="sect3 text-left">
            <h4 id="_serviso_didinimas_pl_timas">Serviso didinimas (plėtimas)</h4>
            <div class="olist arabic">
              <ol class="arabic">
                <li>
                  <p>Padidinu (išplečiu) servisą iki trijų replikų:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker service scale kursinis-web-service=3
kursinis-web-service scaled to 3
overall progress: 0 out of 3 tasks
1/3:
2/3:
3/3:
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 1 out of 3 tasks
overall progress: 2 out of 3 tasks
overall progress: 2 out of 3 tasks
overall progress: 2 out of 3 tasks
overall progress: 2 out of 3 tasks
overall progress: 3 out of 3 tasks
verify: Waiting 5 seconds to verify that tasks are stable...
verify: Waiting 5 seconds to verify that tasks are stable...
verify: Waiting 5 seconds to verify that tasks are stable...
verify: Waiting 5 seconds to verify that tasks are stable...
verify: Waiting 5 seconds to verify that tasks are stable...
verify: Waiting 4 seconds to verify that tasks are stable...
verify: Waiting 4 seconds to verify that tasks are stable...
verify: Waiting 4 seconds to verify that tasks are stable...
verify: Waiting 4 seconds to verify that tasks are stable...
verify: Waiting 4 seconds to verify that tasks are stable...
verify: Waiting 3 seconds to verify that tasks are stable...
verify: Waiting 3 seconds to verify that tasks are stable...
verify: Waiting 3 seconds to verify that tasks are stable...
verify: Waiting 3 seconds to verify that tasks are stable...
verify: Waiting 2 seconds to verify that tasks are stable...
verify: Waiting 2 seconds to verify that tasks are stable...
verify: Waiting 2 seconds to verify that tasks are stable...
verify: Waiting 2 seconds to verify that tasks are stable...
verify: Waiting 1 seconds to verify that tasks are stable...
verify: Waiting 1 seconds to verify that tasks are stable...
verify: Waiting 1 seconds to verify that tasks are stable...
verify: Waiting 1 seconds to verify that tasks are stable...
verify: Waiting 1 seconds to verify that tasks are stable...
verify: Service converged</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Ir tikrinu serviso pasiekiamumą iš naujo:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ curl -s 192.168.56.101
&lt;h1&gt;This request was processed by host: 04bce300bcc1&lt;/h1&gt;

$ curl -s 192.168.56.101
&lt;h1&gt;This request was processed by host: 3d80ed3126b6&lt;/h1&gt;

$ curl -s 192.168.56.101
&lt;h1&gt;This request was processed by host: 9c2d26cbff9e&lt;/h1&gt;

$ curl -s 192.168.56.101
&lt;h1&gt;This request was processed by host: 04bce300bcc1&lt;/h1&gt;

$ curl -s 192.168.56.101
&lt;h1&gt;This request was processed by host: 3d80ed3126b6&lt;/h1&gt;

$ curl -s 192.168.56.101
&lt;h1&gt;This request was processed by host: 9c2d26cbff9e&lt;/h1&gt;

$ curl -s 192.168.56.101
&lt;h1&gt;This request was processed by host: 04bce300bcc1&lt;/h1&gt;

$ curl -s 192.168.56.101
&lt;h1&gt;This request was processed by host: 3d80ed3126b6&lt;/h1&gt;

$ curl -s 192.168.56.101
&lt;h1&gt;This request was processed by host: 9c2d26cbff9e&lt;/h1&gt;</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>&#8658; Atsakymuose matyti trys skirtingi Host-id.</p>
                  </div>
                </li>
                <li>
                  <p>Tikrinu serviso būsenos detales:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker service inspect --pretty kursinis-web-service

ID:             p7imsxwi9midpu5b378srq54w
Name:           kursinis-web-service
Service Mode:   Replicated
 Replicas:      3
Placement:
UpdateConfig:
 Parallelism:   1
 On failure:    pause
 Monitoring Period: 5s
 Max failure ratio: 0
 Update order:      stop-first
RollbackConfig:
 Parallelism:   1
 On failure:    pause
 Monitoring Period: 5s
 Max failure ratio: 0
 Rollback order:    stop-first
ContainerSpec:
 Image:         katacoda/docker-http-server:latest@sha256:76dc8a47fd019f80f2a3163aba789faf55b41b2fb06397653610c754cb12d3ee
 Init:          false
Resources:
Endpoint Mode:  vip
Ports:
 PublishedPort = 80
  Protocol = tcp
  TargetPort = 80
  PublishMode = ingress

$ ssh swarm-n01-oam sudo docker service ls
ID             NAME                   MODE         REPLICAS   IMAGE                                PORTS
p7imsxwi9mid   kursinis-web-service   replicated   3/3        katacoda/docker-http-server:latest   *:80-&gt;80/tcp</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>Rodo tris replikas, kaip ir nurodžiau plėsdamas.</p>
                  </div>
                </li>
                <li>
                  <p>Tikrinu pavienius konteinerius:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker ps
CONTAINER ID   IMAGE                                COMMAND   CREATED         STATUS         PORTS     NAMES
9c2d26cbff9e   katacoda/docker-http-server:latest   "/app"    7 minutes ago   Up 7 minutes   80/tcp    kursinis-web-service.1.vekfptu7x3egid5me161x4gbj

$ ssh swarm-n02-oam sudo docker ps
CONTAINER ID   IMAGE                                COMMAND   CREATED              STATUS              PORTS     NAMES
04bce300bcc1   katacoda/docker-http-server:latest   "/app"    About a minute ago   Up About a minute   80/tcp    kursinis-web-service.2.y8zkkc2pgpj6q0rijb372wooo

$ ssh swarm-n03-oam sudo docker ps
CONTAINER ID   IMAGE                                COMMAND   CREATED              STATUS              PORTS     NAMES
3d80ed3126b6   katacoda/docker-http-server:latest   "/app"    About a minute ago   Up About a minute   80/tcp    kursinis-web-service.3.f7aekzcbukx3c8bjojsl2v4i1</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>&#8658; Konteinerių ID atitinka http-atsakymuose matomus Hostų
                      id.</p>
                  </div>
                </li>
                <li>
                  <p>Dabartinis paslaugos pasiekiamumas klasteryje pagal <em>Manager</em>:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker service ps kursinis-web-service
ID             NAME                     IMAGE                                NODE        DESIRED STATE   CURRENT STATE            ERROR     PORTS
vekfptu7x3eg   kursinis-web-service.1   katacoda/docker-http-server:latest   swarm-n01   Running         Running 21 minutes ago
y8zkkc2pgpj6   kursinis-web-service.2   katacoda/docker-http-server:latest   swarm-n02   Running         Running 14 minutes ago
f7aekzcbukx3   kursinis-web-service.3   katacoda/docker-http-server:latest   swarm-n03   Running         Running 14 minutes ago</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>&#8658; Kiekvienam klasterio mazge veikia po vieną serviso egzempliorių
                      (kopiją, repliką).</p>
                  </div>
                </li>
                <li>
                  <p>Išorės užklausų siuntimas į pirmą mazgą:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ curl -s swarm-n01-oam
&lt;h1&gt;This request was processed by host: 04bce300bcc1&lt;/h1&gt;

$ curl -s swarm-n01-oam
&lt;h1&gt;This request was processed by host: 3d80ed3126b6&lt;/h1&gt;

$ curl -s swarm-n01-oam
&lt;h1&gt;This request was processed by host: 9c2d26cbff9e&lt;/h1&gt;

$ curl -s swarm-n01-oam
&lt;h1&gt;This request was processed by host: 04bce300bcc1&lt;/h1&gt;</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>Atsako trys skirtingi konteineriai.</p>
                  </div>
                </li>
                <li>
                  <p>Išorės užklausų siuntimas į antrą mazgą:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ curl -s swarm-n02-oam
&lt;h1&gt;This request was processed by host: 04bce300bcc1&lt;/h1&gt;

$ curl -s swarm-n02-oam
&lt;h1&gt;This request was processed by host: 3d80ed3126b6&lt;/h1&gt;

$ curl -s swarm-n02-oam
&lt;h1&gt;This request was processed by host: 9c2d26cbff9e&lt;/h1&gt;

$ curl -s swarm-n02-oam
&lt;h1&gt;This request was processed by host: 04bce300bcc1&lt;/h1&gt;

$ curl -s swarm-n02-oam
&lt;h1&gt;This request was processed by host: 3d80ed3126b6&lt;/h1&gt;</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>Atsako trys tie patys skirtingi konteineriai.</p>
                  </div>
                </li>
                <li>
                  <p>Išorės užklausų siuntimas į trečią mazgą:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ curl -s swarm-n03-oam
&lt;h1&gt;This request was processed by host: 04bce300bcc1&lt;/h1&gt;

$ curl -s swarm-n03-oam
&lt;h1&gt;This request was processed by host: 3d80ed3126b6&lt;/h1&gt;

$ curl -s swarm-n03-oam
&lt;h1&gt;This request was processed by host: 9c2d26cbff9e&lt;/h1&gt;

$ curl -s swarm-n03-oam
&lt;h1&gt;This request was processed by host: 04bce300bcc1&lt;/h1&gt;

$ curl -s swarm-n03-oam
&lt;h1&gt;This request was processed by host: 3d80ed3126b6&lt;/h1&gt;

$ curl -s swarm-n03-oam
&lt;h1&gt;This request was processed by host: 9c2d26cbff9e&lt;/h1&gt;

$ curl -s swarm-n03-oam
&lt;h1&gt;This request was processed by host: 04bce300bcc1&lt;/h1&gt;

$ curl -s swarm-n03-oam
&lt;h1&gt;This request was processed by host: 3d80ed3126b6&lt;/h1&gt;

$ curl -s swarm-n03-oam
&lt;h1&gt;This request was processed by host: 9c2d26cbff9e&lt;/h1&gt;

$ curl -s swarm-n03-oam
&lt;h1&gt;This request was processed by host: 04bce300bcc1&lt;/h1&gt;

$ curl -s swarm-n03-oam
&lt;h1&gt;This request was processed by host: 3d80ed3126b6&lt;/h1&gt;

$ curl -s swarm-n03-oam
&lt;h1&gt;This request was processed by host: 9c2d26cbff9e&lt;/h1&gt;</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>Atsako vėl tie patys trys konteineriai.</p>
                  </div>
                  <div class="paragraph">
                    <p>&#8658; Paslauga veikia trijuose mazguose, visame klasteryje.</p>
                  </div>
                </li>
              </ol>
            </div>
            <div class="paragraph">
              <p>&#160;</p>
            </div>
          </div>
          <div class="sect3 text-left">
            <h4 id="_klasterio_elemento_gedimas_ir_taka">Klasterio elemento gedimas ir įtaka</h4>
            <div class="olist arabic">
              <ol class="arabic">
                <li>
                  <p>Tikrinu paslaugos pasiskirstymą:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker service ps kursinis-web-service | grep -v Shut
ID             NAME                         IMAGE                                NODE        DESIRED STATE   CURRENT STATE                    ERROR                         PORTS
j7pgc2beau6m   kursinis-web-service.1       katacoda/docker-http-server:latest   swarm-n01   Running         Running about a minute ago
thiskoiwddq2   kursinis-web-service.2       katacoda/docker-http-server:latest   swarm-n02   Running         Running less than a second ago
dkz7wktnswg0   kursinis-web-service.4       katacoda/docker-http-server:latest   swarm-n03   Running         Running 41 minutes ago</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Pasirenku pagrindinio mazgo (kuriame veikia _Manager) klasterinę
                    tinklo „koją“ ir ją atjungiu:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ VBoxManage list vms
"swarm-n01" {ae06ba44-a60d-44a3-91ac-abae7edfa962}
"swarm-n02" {ab715077-c6b7-4f6a-bb9a-aeed78bd658e}
"swarm-n03" {9c308870-6fa6-4288-bfb3-5446d37652a1}

$ VBoxManage controlvm "swarm-n01" setlinkstate2 off</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Iškart tikrinu tiesiogines užklausas per antrą mazgą:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ curl --connect-timeout 1 swarm-n02-oam
&lt;h1&gt;This request was processed by host: 1bc7dedde9b6&lt;/h1&gt;

$ curl --connect-timeout 1 swarm-n02-oam
curl: (28) Connection timeout after 1001 ms

$ curl --connect-timeout 1 swarm-n02-oam
&lt;h1&gt;This request was processed by host: 84fe7b5b47b1&lt;/h1&gt;

$ curl --connect-timeout 1 swarm-n02-oam
&lt;h1&gt;This request was processed by host: 1bc7dedde9b6&lt;/h1&gt;

$ curl --connect-timeout 1 swarm-n02-oam
&lt;h1&gt;This request was processed by host: 84fe7b5b47b1&lt;/h1&gt;

$ curl --connect-timeout 1 swarm-n02-oam
&lt;h1&gt;This request was processed by host: 1bc7dedde9b6&lt;/h1&gt;

$ curl --connect-timeout 1 swarm-n02-oam
&lt;h1&gt;This request was processed by host: 84fe7b5b47b1&lt;/h1&gt;</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>&#8658; Netrukus po pirmo mazgo klasterinės „kojos“ atjungimo
                      antrame mazge įvyko trūktelėjimas. &#8658; Antro mazgo atsakymuose
                      teliko tik du skirtingi konteinerių / virtualių hostų ID.</p>
                  </div>
                </li>
                <li>
                  <p>Tas pats ir su užklausomis į trečią mazgą:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ curl --connect-timeout 1 swarm-n03-oam
&lt;h1&gt;This request was processed by host: 84fe7b5b47b1&lt;/h1&gt;

$ curl --connect-timeout 1 swarm-n03-oam
&lt;h1&gt;This request was processed by host: 1bc7dedde9b6&lt;/h1&gt;

$ curl --connect-timeout 1 swarm-n03-oam
&lt;h1&gt;This request was processed by host: 84fe7b5b47b1&lt;/h1&gt;

$ curl --connect-timeout 1 swarm-n03-oam
&lt;h1&gt;This request was processed by host: 1bc7dedde9b6&lt;/h1&gt;

$ curl --connect-timeout 1 swarm-n03-oam
&lt;h1&gt;This request was processed by host: 84fe7b5b47b1&lt;/h1&gt;

$ curl --connect-timeout 1 swarm-n03-oam
&lt;h1&gt;This request was processed by host: 1bc7dedde9b6&lt;/h1&gt;</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Tačiau pirmas mazgas gražina jau <strong>tris</strong> skirtingus,
                    bet jau truputį kitokius ID:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ curl --connect-timeout 1 swarm-n01-oam
&lt;h1&gt;This request was processed by host: 070aa3e17d4a&lt;/h1&gt;

$ curl --connect-timeout 1 swarm-n01-oam
&lt;h1&gt;This request was processed by host: fce23fdeab52&lt;/h1&gt;

$ curl --connect-timeout 1 swarm-n01-oam
&lt;h1&gt;This request was processed by host: fda749b30050&lt;/h1&gt;

$ curl --connect-timeout 1 swarm-n01-oam
&lt;h1&gt;This request was processed by host: 070aa3e17d4a&lt;/h1&gt;</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Tikrinu serviso replikas pagal menedžerį:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker service ps kursinis-web-service | grep -v Shut
ID             NAME                         IMAGE                                NODE        DESIRED STATE   CURRENT STATE                     ERROR                         PORTS
j7pgc2beau6m   kursinis-web-service.1       katacoda/docker-http-server:latest   swarm-n01   Running         Running 5 minutes ago
ypinuj5i68bo   kursinis-web-service.2       katacoda/docker-http-server:latest   swarm-n01   Running         Running 2 minutes ago
1ygslm1t3iwn   kursinis-web-service.4       katacoda/docker-http-server:latest   swarm-n01   Running         Running 2 minutes ago</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>&#8658; Panašu, kad <em>Manager</em> trūko dviejų serviso replikų,
                      ir jis jas susikūrė savo mazge. <br></p>
                  </div>
                  <div class="paragraph">
                    <p>Tik liūdna, kad jei nodas teturėtų vienintelį tinklo interfeisą,
                      jis nebebūtų niekaip pasiekiamas. <br> Ir produkcijoje jis
                      tiesiog neveiktų, nors jam „atrodytų“, kad jis veikia.</p>
                  </div>
                </li>
                <li>
                  <p>Tikrinu atskirus konteinerius pirmame mazge:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker ps
CONTAINER ID   IMAGE                                COMMAND   CREATED                  STATUS          PORTS     NAMES
fda749b30050   katacoda/docker-http-server:latest   "/app"    Less than a second ago   Up 3 minutes    80/tcp    kursinis-web-service.1.j7pgc2beau6m7m59wc49parbu
070aa3e17d4a   katacoda/docker-http-server:latest   "/app"    30 seconds ago           Up 23 seconds   80/tcp    kursinis-web-service.2.ypinuj5i68bo9u9tvyrm08l5l
fce23fdeab52   katacoda/docker-http-server:latest   "/app"    30 seconds ago           Up 26 seconds   80/tcp    kursinis-web-service.4.1ygslm1t3iwnmykv0rl8au9ww</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Tikrinu atskirus konteinerius antrame mazge:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n02-oam sudo docker ps
CONTAINER ID   IMAGE                                COMMAND   CREATED          STATUS          PORTS     NAMES
84fe7b5b47b1   katacoda/docker-http-server:latest   "/app"    42 minutes ago   Up 42 minutes   80/tcp    kursinis-web-service.2.thiskoiwddq2w5h561v789pzd</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Tikrinu atskirus konteinerius trečiame mazge:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n03-oam sudo docker ps
CONTAINER ID   IMAGE                                COMMAND   CREATED             STATUS             PORTS     NAMES
1bc7dedde9b6   katacoda/docker-http-server:latest   "/app"    About an hour ago   Up About an hour   80/tcp    kursinis-web-service.4.dkz7wktnswg0ajzc5v58xwytc</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>&#8658; Panašu, kad klasteris pateko į <em>Split-brain</em> būseną:</p>
                  </div>
                  <div class="ulist">
                    <ul>
                      <li>
                        <p>Antrame ir trečiame mazguose veikia po vieną konteinerį (kaip
                          ir buvo iki splito). <br> Kadangi juose neveikia menedžeris,
                          jie stengiasi išlaikyti būseną. <br> Jie tiesiog aptarnauja
                          užklausas jas tarpusavyje balansuodami.</p>
                      </li>
                      <li>
                        <p>Gi pirmame mazge susikūrė po dvi kopijas trūkstamų serviso
                          replikų <br> (likusių antrame ir trečiame mazguose, ir
                          dabar pirmam nebematomų). <br> Ir jis <strong>irgi</strong>                          atsako į užklausas, bet nebepriklausomai nuo veiklos antrame
                          ir trečiame mazguose.</p>
                      </li>
                      <li>
                        <p>T. y. iš esmės gavome du klasterius:</p>
                        <div class="olist arabic">
                          <ol class="arabic">
                            <li>
                              <p><code>swarm-n01</code> su trimis replikomis viename
                                mazge.</p>
                            </li>
                            <li>
                              <p><code>swarm-n02</code>+<code>swarm-n03</code> su dviem
                                replikomis (po vieną kiekviename mazge).</p>
                            </li>
                          </ol>
                        </div>
                      </li>
                    </ul>
                  </div>
                </li>
                <li>
                  <p>Grąžinu virtualų tinklo kabelį į vietą:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ VBoxManage controlvm "swarm-n01" setlinkstate2 on</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Tikrinu konteinerius trečiame mazge:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n03-oam sudo docker ps
CONTAINER ID   IMAGE                                COMMAND   CREATED             STATUS             PORTS     NAMES
1bc7dedde9b6   katacoda/docker-http-server:latest   "/app"    About an hour ago   Up About an hour   80/tcp    kursinis-web-service.4.dkz7wktnswg0ajzc5v58xwytc</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>&#8658; Vis dar veikia.</p>
                  </div>
                </li>
                <li>
                  <p>Tikrinu</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>osboxes@swarm-n01:~$ dmesg -T | tail
[Wed Feb  9 12:16:15 2022] br0: port 4(veth2) entered forwarding state
[Wed Feb  9 12:16:15 2022] eth1: renamed from veth5b1e10c
[Wed Feb  9 12:16:15 2022] IPv6: ADDRCONF(NETDEV_CHANGE): vethffa8387: link becomes ready
[Wed Feb  9 12:16:15 2022] docker_gwbridge: port 4(vethffa8387) entered blocking state
[Wed Feb  9 12:16:15 2022] docker_gwbridge: port 4(vethffa8387) entered forwarding state
[Wed Feb  9 12:16:15 2022] eth1: renamed from vetha1c4f83
[Wed Feb  9 12:16:15 2022] IPv6: ADDRCONF(NETDEV_CHANGE): veth36d686a: link becomes ready
[Wed Feb  9 12:16:15 2022] docker_gwbridge: port 3(veth36d686a) entered blocking state
[Wed Feb  9 12:16:15 2022] docker_gwbridge: port 3(veth36d686a) entered forwarding state
[Wed Feb  9 12:17:40 2022] e1000: enp0s8 NIC Link is Up 1000 Mbps Full Duplex, Flow Control: RX

osboxes@swarm-n01:~$ ethtool enp0s8
Settings for enp0s8:
        Supported ports: [ TP ]
        Supported link modes:   10baseT/Half 10baseT/Full
                                100baseT/Half 100baseT/Full
                                1000baseT/Full
        Supported pause frame use: No
        Supports auto-negotiation: Yes
        Supported FEC modes: Not reported
        Advertised link modes:  10baseT/Half 10baseT/Full
                                100baseT/Half 100baseT/Full
                                1000baseT/Full
        Advertised pause frame use: No
        Advertised auto-negotiation: Yes
        Advertised FEC modes: Not reported
        Speed: 1000Mb/s
        Duplex: Full
        Port: Twisted Pair
        PHYAD: 0
        Transceiver: internal
        Auto-negotiation: on
        MDI-X: off (auto)
Cannot get wake-on-lan settings: Operation not permitted
        Current message level: 0x00000007 (7)
                               drv probe link
        Link detected: yes</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>&#8658; Virtualus tinklo kabelis tikrai vėl prijungtas.</p>
                  </div>
                </li>
                <li>
                  <p>Tikrinu mazgų būsenas ir serviso replikas:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker node ls
ID                            HOSTNAME    STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
l6wnnbsgv2th6nq05e9j02srj *   swarm-n01   Ready     Active         Leader           20.10.12
a50ddvlva40nzzvtxu1hpsus7     swarm-n02   Ready     Active                          20.10.12
6qeivl6aatpwxb50vi8hpr4bh     swarm-n03   Ready     Active                          20.10.12

$ ssh swarm-n01-oam sudo docker service ps kursinis-web-service | grep -v Shut
ID             NAME                         IMAGE                                NODE        DESIRED STATE   CURRENT STATE                     ERROR                         PORTS
j7pgc2beau6m   kursinis-web-service.1       katacoda/docker-http-server:latest   swarm-n01   Running         Running 5 minutes ago
ypinuj5i68bo   kursinis-web-service.2       katacoda/docker-http-server:latest   swarm-n01   Running         Running 2 minutes ago
1ygslm1t3iwn   kursinis-web-service.4       katacoda/docker-http-server:latest   swarm-n01   Running         Running 2 minutes ago</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>&#8658; Klasteryje vėl trys mazgai. Visos trys replikos veikia
                      tik pirmame mazge.</p>
                  </div>
                </li>
                <li>
                  <p>Tikrinu konteinerius kituose individualiai. Pirmame mazge:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker ps
CONTAINER ID   IMAGE                                COMMAND   CREATED                  STATUS          PORTS     NAMES
fda749b30050   katacoda/docker-http-server:latest   "/app"    Less than a second ago   Up 3 minutes    80/tcp    kursinis-web-service.1.j7pgc2beau6m7m59wc49parbu
070aa3e17d4a   katacoda/docker-http-server:latest   "/app"    30 seconds ago           Up 23 seconds   80/tcp    kursinis-web-service.2.ypinuj5i68bo9u9tvyrm08l5l
fce23fdeab52   katacoda/docker-http-server:latest   "/app"    30 seconds ago           Up 26 seconds   80/tcp    kursinis-web-service.4.1ygslm1t3iwnmykv0rl8au9ww</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Antrame mazge:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n02-oam sudo docker ps
CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Trečiame mazge:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n03-oam sudo docker ps
CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>&#8658; Kai tik pirmas mazgas „pamatė“ antrąjį ir trečiąjį, iškart
                      išjungė perteklines replikas juose. <br>
                      <em>Split-brain</em> būsena išnyko.</p>
                  </div>
                </li>
                <li>
                  <p>Dėl visa ko tikrinu ID, gražinamus užklausose į trečią mazgą:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ curl --connect-timeout 1 swarm-n03-oam
&lt;h1&gt;This request was processed by host: 070aa3e17d4a&lt;/h1&gt;

$ curl --connect-timeout 1 swarm-n03-oam
&lt;h1&gt;This request was processed by host: fce23fdeab52&lt;/h1&gt;

$ curl --connect-timeout 1 swarm-n03-oam
&lt;h1&gt;This request was processed by host: fda749b30050&lt;/h1&gt;

$ curl --connect-timeout 1 swarm-n03-oam
&lt;h1&gt;This request was processed by host: 070aa3e17d4a&lt;/h1&gt;

$ curl --connect-timeout 1 swarm-n03-oam
&lt;h1&gt;This request was processed by host: fce23fdeab52&lt;/h1&gt;

$ curl --connect-timeout 1 swarm-n03-oam
&lt;h1&gt;This request was processed by host: fda749b30050&lt;/h1&gt;

$ curl --connect-timeout 1 swarm-n03-oam
&lt;h1&gt;This request was processed by host: 070aa3e17d4a&lt;/h1&gt;</pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>&#8658; ID matyti trys skirtingi, ir jie atitinka <code>swarm-n01</code>                      konteinerius.</p>
                  </div>
                </li>
                <li>
                  <p>Taip keičiasi mazgų būsenos atjungus interfeisą:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ VBoxManage controlvm "swarm-n01" setlinkstate2 off

$ ssh swarm-n01-oam sudo docker node ls
ID                            HOSTNAME    STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
l6wnnbsgv2th6nq05e9j02srj *   swarm-n01   Ready     Active         Leader           20.10.12
a50ddvlva40nzzvtxu1hpsus7     swarm-n02   Ready     Active                          20.10.12
6qeivl6aatpwxb50vi8hpr4bh     swarm-n03   Ready     Active                          20.10.12

$ ssh swarm-n01-oam sudo docker node ls
ID                            HOSTNAME    STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
l6wnnbsgv2th6nq05e9j02srj *   swarm-n01   Ready     Active         Leader           20.10.12
a50ddvlva40nzzvtxu1hpsus7     swarm-n02   Down      Active                          20.10.12
6qeivl6aatpwxb50vi8hpr4bh     swarm-n03   Ready     Active                          20.10.12

$ ssh swarm-n01-oam sudo docker node ls
ID                            HOSTNAME    STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
l6wnnbsgv2th6nq05e9j02srj *   swarm-n01   Ready     Active         Leader           20.10.12
a50ddvlva40nzzvtxu1hpsus7     swarm-n02   Down      Active                          20.10.12
6qeivl6aatpwxb50vi8hpr4bh     swarm-n03   Down      Active                          20.10.12</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>O taip keičiasi interfeisą vėl prijungus:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ VBoxManage controlvm "swarm-n01" setlinkstate2 on

$ ssh swarm-n01-oam sudo docker node ls
ID                            HOSTNAME    STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
l6wnnbsgv2th6nq05e9j02srj *   swarm-n01   Ready     Active         Leader           20.10.12
a50ddvlva40nzzvtxu1hpsus7     swarm-n02   Down      Active                          20.10.12
6qeivl6aatpwxb50vi8hpr4bh     swarm-n03   Down      Active                          20.10.12

$ ssh swarm-n01-oam sudo docker node ls
ID                            HOSTNAME    STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
l6wnnbsgv2th6nq05e9j02srj *   swarm-n01   Ready     Active         Leader           20.10.12
a50ddvlva40nzzvtxu1hpsus7     swarm-n02   Down      Active                          20.10.12
6qeivl6aatpwxb50vi8hpr4bh     swarm-n03   Down      Active                          20.10.12

$ ssh swarm-n01-oam sudo docker node ls
ID                            HOSTNAME    STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
l6wnnbsgv2th6nq05e9j02srj *   swarm-n01   Ready     Active         Leader           20.10.12
a50ddvlva40nzzvtxu1hpsus7     swarm-n02   Down      Active                          20.10.12
6qeivl6aatpwxb50vi8hpr4bh     swarm-n03   Down      Active                          20.10.12

$ ssh swarm-n01-oam sudo docker node ls
ID                            HOSTNAME    STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
l6wnnbsgv2th6nq05e9j02srj *   swarm-n01   Ready     Active         Leader           20.10.12
a50ddvlva40nzzvtxu1hpsus7     swarm-n02   Ready     Active                          20.10.12
6qeivl6aatpwxb50vi8hpr4bh     swarm-n03   Down      Active                          20.10.12

$ ssh swarm-n01-oam sudo docker node ls
ID                            HOSTNAME    STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
l6wnnbsgv2th6nq05e9j02srj *   swarm-n01   Ready     Active         Leader           20.10.12
a50ddvlva40nzzvtxu1hpsus7     swarm-n02   Ready     Active                          20.10.12
6qeivl6aatpwxb50vi8hpr4bh     swarm-n03   Ready     Active                          20.10.12</pre>
                    </div>
                  </div>
                </li>
              </ol>
            </div>
            <div class="paragraph">
              <p>&#160;</p>
            </div>
          </div>
          <div class="sect3 text-left">
            <h4 id="_tolygus_replik_paskirstymo_atstatymas_klasteryje">Tolygus replikų paskirstymo atstatymas klasteryje</h4>
            <div class="olist arabic">
              <ol class="arabic">
                <li>
                  <p>Atstatau tinklo ryšį:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ VBoxManage controlvm "swarm-n01" setlinkstate2 on</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>&#8230;&#8203; ir sumažinu servisą iki dviejų replikų:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker service scale kursinis-web-service=2
kursinis-web-service scaled to 2
overall progress: 0 out of 2 tasks
1/2:
2/2:
overall progress: 3 out of 2 tasks
overall progress: 2 out of 2 tasks
verify: Waiting 5 seconds to verify that tasks are stable...
overall progress: 2 out of 2 tasks
verify: Waiting 5 seconds to verify that tasks are stable...
overall progress: 2 out of 2 tasks
verify: Waiting 5 seconds to verify that tasks are stable...
overall progress: 2 out of 2 tasks
verify: Waiting 5 seconds to verify that tasks are stable...
overall progress: 2 out of 2 tasks
verify: Waiting 4 seconds to verify that tasks are stable...
overall progress: 2 out of 2 tasks
verify: Waiting 4 seconds to verify that tasks are stable...
overall progress: 2 out of 2 tasks
verify: Waiting 4 seconds to verify that tasks are stable...
overall progress: 2 out of 2 tasks
verify: Waiting 4 seconds to verify that tasks are stable...
overall progress: 2 out of 2 tasks
verify: Waiting 4 seconds to verify that tasks are stable...
overall progress: 2 out of 2 tasks
verify: Waiting 3 seconds to verify that tasks are stable...
overall progress: 2 out of 2 tasks
verify: Waiting 3 seconds to verify that tasks are stable...
overall progress: 2 out of 2 tasks
verify: Waiting 3 seconds to verify that tasks are stable...
overall progress: 2 out of 2 tasks
verify: Waiting 3 seconds to verify that tasks are stable...
overall progress: 2 out of 2 tasks
verify: Waiting 2 seconds to verify that tasks are stable...
overall progress: 2 out of 2 tasks
verify: Waiting 2 seconds to verify that tasks are stable...
overall progress: 2 out of 2 tasks
verify: Waiting 2 seconds to verify that tasks are stable...
overall progress: 2 out of 2 tasks
verify: Waiting 2 seconds to verify that tasks are stable...
overall progress: 2 out of 2 tasks
verify: Waiting 2 seconds to verify that tasks are stable...
overall progress: 2 out of 2 tasks
verify: Waiting 1 seconds to verify that tasks are stable...
overall progress: 2 out of 2 tasks
verify: Waiting 1 seconds to verify that tasks are stable...
overall progress: 2 out of 2 tasks
verify: Waiting 1 seconds to verify that tasks are stable...
overall progress: 2 out of 2 tasks
verify: Waiting 1 seconds to verify that tasks are stable...
verify: Service converged</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Patikrinu konteinerius atskiruose mazguose:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ for NODE in swarm-n0{1..3}-oam; do echo On $NODE:; ssh $NODE sudo docker ps; echo; done
On swarm-n01-oam:
CONTAINER ID   IMAGE                                COMMAND   CREATED          STATUS          PORTS     NAMES
9c2d26cbff9e   katacoda/docker-http-server:latest   "/app"    42 minutes ago   Up 42 minutes   80/tcp    kursinis-web-service.1.vekfptu7x3egid5me161x4gbj

On swarm-n02-oam:
CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES

On swarm-n03-oam:
CONTAINER ID   IMAGE                                COMMAND   CREATED              STATUS              PORTS     NAMES
742f620f02d8   katacoda/docker-http-server:latest   "/app"    About a minute ago   Up About a minute   80/tcp    kursinis-web-service.6.h6ofhnw567zm36xdrgk0wbae6</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Padidinu servisą iki trijų replikų:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker service scale kursinis-web-service=3
kursinis-web-service scaled to 3
overall progress: 0 out of 3 tasks
1/3:
2/3:
3/3:
overall progress: 2 out of 3 tasks
overall progress: 2 out of 3 tasks
overall progress: 2 out of 3 tasks
overall progress: 2 out of 3 tasks
overall progress: 2 out of 3 tasks
overall progress: 2 out of 3 tasks
overall progress: 2 out of 3 tasks
overall progress: 3 out of 3 tasks
verify: Waiting 5 seconds to verify that tasks are stable...
verify: Waiting 5 seconds to verify that tasks are stable...
verify: Waiting 5 seconds to verify that tasks are stable...
verify: Waiting 5 seconds to verify that tasks are stable...
verify: Waiting 5 seconds to verify that tasks are stable...
verify: Waiting 4 seconds to verify that tasks are stable...
verify: Waiting 4 seconds to verify that tasks are stable...
verify: Waiting 4 seconds to verify that tasks are stable...
verify: Waiting 4 seconds to verify that tasks are stable...
verify: Waiting 3 seconds to verify that tasks are stable...
verify: Waiting 3 seconds to verify that tasks are stable...
verify: Waiting 3 seconds to verify that tasks are stable...
verify: Waiting 3 seconds to verify that tasks are stable...
verify: Waiting 3 seconds to verify that tasks are stable...
verify: Waiting 2 seconds to verify that tasks are stable...
verify: Waiting 2 seconds to verify that tasks are stable...
verify: Waiting 2 seconds to verify that tasks are stable...
verify: Waiting 2 seconds to verify that tasks are stable...
verify: Waiting 1 seconds to verify that tasks are stable...
verify: Waiting 1 seconds to verify that tasks are stable...
verify: Waiting 1 seconds to verify that tasks are stable...
verify: Waiting 1 seconds to verify that tasks are stable...
verify: Service converged</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Tikrinu, servisui skirtos trys replikos:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker service ls
ID             NAME                   MODE         REPLICAS   IMAGE                                PORTS
p7imsxwi9mid   kursinis-web-service   replicated   3/3        katacoda/docker-http-server:latest   *:80-&gt;80/tcp</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Vėl veikia po vieną konteinerį (repliką) kiekviename mazge:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ for NODE in swarm-n0{1..3}-oam; do echo On $NODE:; ssh $NODE sudo docker ps; echo; done
On swarm-n01-oam:
CONTAINER ID   IMAGE                                COMMAND   CREATED          STATUS          PORTS     NAMES
9c2d26cbff9e   katacoda/docker-http-server:latest   "/app"    42 minutes ago   Up 42 minutes   80/tcp    kursinis-web-service.1.vekfptu7x3egid5me161x4gbj

On swarm-n02-oam:
CONTAINER ID   IMAGE                                COMMAND   CREATED          STATUS         PORTS     NAMES
75e5c7ff94cc   katacoda/docker-http-server:latest   "/app"    10 seconds ago   Up 8 seconds   80/tcp    kursinis-web-service.2.gmq2jit794eofojcuwlfwda3z

On swarm-n03-oam:
CONTAINER ID   IMAGE                                COMMAND   CREATED         STATUS              PORTS     NAMES
742f620f02d8   katacoda/docker-http-server:latest   "/app"    2 minutes ago   Up About a minute   80/tcp    kursinis-web-service.6.h6ofhnw567zm36xdrgk0wbae6</pre>
                    </div>
                  </div>
                </li>
              </ol>
            </div>
            <div class="paragraph">
              <p>&#160;</p>
            </div>
          </div>
          <div class="sect3 text-left">
            <h4 id="_kito_klasterio_elemento_gedimas_ir_jo_taka">Kito klasterio elemento gedimas ir jo įtaka</h4>
            <div class="olist arabic">
              <ol class="arabic">
                <li>
                  <p>Dėl visa ko pasitikrinu Docker pasistemės vidinių tinklų konfigūraciją:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker network ls
NETWORK ID     NAME              DRIVER    SCOPE
55432975850d   bridge            bridge    local
d5c8e496a396   docker_gwbridge   bridge    local
0cde9da9f77d   host              host      local
vpyp1hp7w63i   ingress           overlay   swarm
7613a3238dce   none              null      local</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Vėl turime servisą, tolygiai pasiskirsčiusį klasteryje:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker service ps kursinis-web-service | grep -v Shut
ID             NAME                         IMAGE                                NODE        DESIRED STATE   CURRENT STATE                    ERROR                         PORTS
vekfptu7x3eg   kursinis-web-service.1       katacoda/docker-http-server:latest   swarm-n01   Running         Running 4 hours ago
xrbcof1qu7n8   kursinis-web-service.2       katacoda/docker-http-server:latest   swarm-n02   Running         Running less than a second ago
dkz7wktnswg0   kursinis-web-service.4       katacoda/docker-http-server:latest   swarm-n03   Running         Running 10 minutes ago</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Šį sykį pilnai išjungiu antrąjį mazgą:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ VBoxManage controlvm "swarm-n02" poweroff
0%...10%...20%...30%...40%...50%...60%...70%...80%...90%...100%</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Po sekundės klasteris gedimo dar nėra aptikęs:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker service ps kursinis-web-service | grep -v Shut
ID             NAME                         IMAGE                                NODE        DESIRED STATE   CURRENT STATE                    ERROR                         PORTS
vekfptu7x3eg   kursinis-web-service.1       katacoda/docker-http-server:latest   swarm-n01   Running         Running 4 hours ago
xrbcof1qu7n8   kursinis-web-service.2       katacoda/docker-http-server:latest   swarm-n02   Running         Running less than a second ago
dkz7wktnswg0   kursinis-web-service.4       katacoda/docker-http-server:latest   swarm-n03   Running         Running 14 minutes ago</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Tačiau po maždaug dviejų sekundžių jau aptinka, kad mazgas <code>swarm-n02</code>                    nebeatsiliepia:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker node ls
ID                            HOSTNAME    STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
l6wnnbsgv2th6nq05e9j02srj *   swarm-n01   Ready     Active         Leader           20.10.12
a50ddvlva40nzzvtxu1hpsus7     swarm-n02   Down      Active                          20.10.12
6qeivl6aatpwxb50vi8hpr4bh     swarm-n03   Ready     Active                          20.10.12</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>&#8230;&#8203; ir perkuria trūkstamą repliką mazge <code>swarm-n01</code>:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n01-oam sudo docker service ps kursinis-web-service | grep -v Shut
ID             NAME                         IMAGE                                NODE        DESIRED STATE   CURRENT STATE                    ERROR                         PORTS
vekfptu7x3eg   kursinis-web-service.1       katacoda/docker-http-server:latest   swarm-n01   Running         Running 4 hours ago
oweiigoueoww   kursinis-web-service.2       katacoda/docker-http-server:latest   swarm-n01   Running         Running 3 seconds ago
dkz7wktnswg0   kursinis-web-service.4       katacoda/docker-http-server:latest   swarm-n03   Running         Running 14 minutes ago

$ ssh swarm-n01-oam sudo docker service ps kursinis-web-service
ID             NAME                         IMAGE                                NODE        DESIRED STATE   CURRENT STATE                    ERROR                         PORTS
vekfptu7x3eg   kursinis-web-service.1       katacoda/docker-http-server:latest   swarm-n01   Running         Running 4 hours ago
oweiigoueoww   kursinis-web-service.2       katacoda/docker-http-server:latest   swarm-n01   Running         Running about a minute ago
xrbcof1qu7n8    \_ kursinis-web-service.2   katacoda/docker-http-server:latest   swarm-n02   Shutdown        Running less than a second ago
gmq2jit794eo    \_ kursinis-web-service.2   katacoda/docker-http-server:latest   swarm-n02   Shutdown        Shutdown about an hour ago
4ekln6k23p0b   kursinis-web-service.3       katacoda/docker-http-server:latest   swarm-n03   Shutdown        Shutdown 25 minutes ago
dkz7wktnswg0   kursinis-web-service.4       katacoda/docker-http-server:latest   swarm-n03   Running         Running 16 minutes ago
q6xeb0896glj    \_ kursinis-web-service.4   katacoda/docker-http-server:latest   swarm-n02   Shutdown        Failed less than a second ago    "task: non-zero exit (255)"</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Tuo tarpu trečias mazgas nukreipia užklausas į visas 3 replikas:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ curl swarm-n03-oam
&lt;h1&gt;This request was processed by host: f88eb8f1a09d&lt;/h1&gt;

$ curl swarm-n03-oam
&lt;h1&gt;This request was processed by host: 1bc7dedde9b6&lt;/h1&gt;

$ curl swarm-n03-oam
&lt;h1&gt;This request was processed by host: 9c2d26cbff9e&lt;/h1&gt;

$ curl swarm-n03-oam
&lt;h1&gt;This request was processed by host: f88eb8f1a09d&lt;/h1&gt;

$ curl swarm-n03-oam
&lt;h1&gt;This request was processed by host: 1bc7dedde9b6&lt;/h1&gt;

$ curl swarm-n03-oam
&lt;h1&gt;This request was processed by host: 9c2d26cbff9e&lt;/h1&gt;</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Taip pat nukreipia ir pirmas mazgas:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ curl swarm-n01-oam
&lt;h1&gt;This request was processed by host: f88eb8f1a09d&lt;/h1&gt;

$ curl swarm-n01-oam
&lt;h1&gt;This request was processed by host: 1bc7dedde9b6&lt;/h1&gt;

$ curl swarm-n01-oam
&lt;h1&gt;This request was processed by host: 9c2d26cbff9e&lt;/h1&gt;

$ curl swarm-n01-oam
&lt;h1&gt;This request was processed by host: f88eb8f1a09d&lt;/h1&gt;

$ curl swarm-n01-oam
&lt;h1&gt;This request was processed by host: 1bc7dedde9b6&lt;/h1&gt;

$ curl swarm-n01-oam
&lt;h1&gt;This request was processed by host: 9c2d26cbff9e&lt;/h1&gt;</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Antras mazgas neatsiliepia, žinoma (nes išjungtas):</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ curl swarm-n02-oam
curl: (28) Failed to connect to swarm-n02-oam port 80 after 21011 ms: Connection timed out</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Įjungiu antrą mazgą ir sulaukiu, kol jis grįš į klasterį:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ VBoxManage startvm "swarm-n02"
Waiting for VM "swarm-n02" to power on...
VM "swarm-n02" has been successfully started.

$ ssh swarm-n01-oam sudo docker node ls
ID                            HOSTNAME    STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
l6wnnbsgv2th6nq05e9j02srj *   swarm-n01   Ready     Active         Leader           20.10.12
a50ddvlva40nzzvtxu1hpsus7     swarm-n02   Ready     Active                          20.10.12
6qeivl6aatpwxb50vi8hpr4bh     swarm-n03   Ready     Active                          20.10.12</pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Deja, nepatikrinau, kaip pasiskirstė serviso replikos. <br></p>
                  <div class="paragraph">
                    <p>Bet pagal šiuos du konteinerių sąrašus panašu, kad dvi veikė
                      <code>swarm-n01</code>, o viena liko <code>swarm-03</code>:</p>
                  </div>
                  <div class="listingblock">
                    <div class="content">
                      <pre>$ ssh swarm-n02-oam sudo docker ps
CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES

$ ssh swarm-n03-oam sudo docker ps
CONTAINER ID   IMAGE                                COMMAND   CREATED          STATUS          PORTS     NAMES
1bc7dedde9b6   katacoda/docker-http-server:latest   "/app"    38 minutes ago   Up 38 minutes   80/tcp    kursinis-web-service.4.dkz7wktnswg0ajzc5v58xwytc</pre>
                    </div>
                  </div>
                </li>
              </ol>
            </div>
            <div class="paragraph">
              <p>&#160;</p>
            </div>
          </div>
          <div class="sect3 text-left">
            <h4 id="__em_web_em_serviso_pasiekiamumas_vairiuose_etapuose"><em>Web</em>-serviso pasiekiamumas įvairiuose etapuose</h4>
            <div class="paragraph">
              <p>Serviso pasiekiamumą įvairiuose etapuose jau atvaizdavau CLI būdu.
                Kai kada, kai <em>Manager</em> neveikia, tai padaryti nėra elegantiška.</p>
            </div>
            <div class="paragraph">
              <p>Dėl visa ko įtraukiu trijų užklausų rezultatus naršyklėje:</p>
            </div>
            <div class="imageblock">
              <div class="content">
                <img src="https://user-images.githubusercontent.com/74717106/153412031-026e354a-1fbc-4284-8c69-a4ade87d7b0f.png"
                  alt="153412031 026e354a 1fbc 4284 8c69 a4ade87d7b0f" width="100%">
              </div>
            </div>
            <div class="paragraph">
              <p>&#160;</p>
            </div>
          </div>
        </div>
        <div class="sect2">
          <h3 id="_3_rezultat_apibendrinimas">3. Rezultatų apibendrinimas</h3>
          <div class="sect3 text-left">
            <h4 id="__">&#160;</h4>
            <div class="paragraph">
              <p>Susikonstravau VM infrastruktūrą VirtuaBox hipervizoriaus (Type II)
                pagrindu. Kiekvienai VM skyriau po tris tinklo interfeisus:</p>
            </div>
            <div class="olist arabic">
              <ol class="arabic">
                <li>
                  <p>prisijungimui prie interneto (atnaujinimų siuntimams ir kt.)</p>
                </li>
                <li>
                  <p>aplikacijai / klasterio mazgų ryšiui;</p>
                </li>
                <li>
                  <p>OS valdymui (OAM).</p>
                </li>
              </ol>
            </div>
            <div class="paragraph">
              <p>Sukūriau tris VM, jose pasinaudojau <em>Docker Swarm Mode</em> technologija
                ir startavau trijų mazgų klasterį:</p>
            </div>
            <div class="olist arabic">
              <ol class="arabic">
                <li>
                  <p><em>Manager + Worker</em>;</p>
                </li>
                <li>
                  <p><em>Worker</em>;</p>
                </li>
                <li>
                  <p><em>Worker</em>.</p>
                </li>
              </ol>
            </div>
            <div class="paragraph">
              <p>Klasteryje <em>Docker</em> konteinerių pagrindu paleidau savo pasirinktą
                <em>Web</em>-servisą <code>katacoda/docker-http-server</code>. Patikrinau
                jį iš savo kompiuterio: pasiekiamas.</p>
            </div>
            <div class="paragraph">
              <p>Sukūriau tris serviso replikas. Patikrinau ir užfiksavau jų pasiskirstymą
                klasteryje.</p>
            </div>
            <div class="paragraph">
              <p>Imitavau klasterio elemento gedimą: atjungiau pirmojo mazgo <code>swarm-n01</code>                klasterinį tinklo interfeisą.</p>
            </div>
            <div class="paragraph">
              <p><em>Manager</em> nustojo matyti likusius du mazgus ir perkūrė du jų
                konteinerius pas save. Bėda, kad jis pats būtų tapęs nepasiekiamu
                produkciniam tinklui (NLB ar maršrutizatoriui). Tačiau per OAM interfeisą
                visi trys konteineriai buvo pasiekiami.</p>
            </div>
            <div class="paragraph">
              <p>Tuo tarpu mazgai <code>swarm-n02</code> ir <code>swarm-n03</code> iškart
                nustojo atsiliepti į užklausas <code>80/TCP</code> portu iš viso,
                nors jų klasteriniai interfeisai ir tebeveikė.</p>
            </div>
            <div class="paragraph">
              <p>Po &lt;20 s. jų atsakymai į užklausas atsistatė&#8201;&#8212;&#8201;jie
                jas pradėjo balansuoti tarpusavyje ir grąžindavo jau du skirtingus
                <em>Host-id</em>.</p>
            </div>
            <div class="paragraph">
              <p>Iš esmės, situacija mano vertinimu atitinka klasterinį <em>Split-brain</em>                scenarijų, kai abi klasterio dalys nusprendžia, kad kita pusė nebeveikia,
                ir bando veikti abi nepriklausomai.</p>
            </div>
            <div class="ulist">
              <ul>
                <li>
                  <p>&#8658; Darau išvadą, kad klasteriui paskyrus tiek nedaug mazgų,
                    vertėtų padidinti ne tik <em>Worker</em> skaičių, bet ir <em>Manager</em>                    skaičių.</p>
                  <div class="paragraph">
                    <p>Priešingu atveju įmanomas pavojus duomenų vientisumui, kai dvi
                      grupės vienu metu keis tuos pačius duomenis, bet kiekviena
                      laikys, kad keičia tik ji pati, tik viena grupė.</p>
                  </div>
                </li>
              </ul>
            </div>
            <div class="paragraph">
              <p>Toliau atstačiau tinklo veikimą, ir stebėjau konteinerių būsenas tiek
                <em>Worker</em> mazguose, tiek <em>Manager</em> mazge. Netrukus jie
                pradėjo atsakymuose grąžinti naujus <em>Host-id</em>.</p>
            </div>
            <div class="paragraph">
              <p>Patikrinus pasirodė, kad visi šie <em>Host-id</em> priklauso <code>swarm-n01</code>                mazge veikiantiems dviems naujiems konteineriams, sukurtiems splito
                metu. Ir dabar šiaip paslaugai visos trys replikos veikė būtent šiame
                mazge. Konteineriai <em>Worker</em> mazguose išsijungė netrukus po
                <em>Manager</em> tinklo atstatymo.</p>
            </div>
            <div class="paragraph">
              <p>Po šito paskirsčiau replikas vėl po lygiai&#8201;&#8212;&#8201;po vieną
                kiekvienam mazgui: <code>&#8230;&#8203; scale kursinis-web-service=1</code>                ir <code>&#8230;&#8203; scale kursinis-web-service=3</code>.</p>
            </div>
            <div class="paragraph">
              <p>Ir kai tuo tarpu pilnai išjungiau antrą mazgą, <code>swarm-n02</code>,
                jo replika buvo pakeista nauja replika pirmajame mazge, <code>swarm-n01</code>.</p>
            </div>
            <div class="paragraph">
              <p>Į užklausas abu tebeveikiantys mazgai atsakydavo sėkmingai (<code>swarm-n01</code>                ir <code>swarm-n03</code>).</p>
            </div>
            <div class="paragraph">
              <p>Mazgą <code>swarm-n02</code> vėl įjungus, jis pats sugrįžo į klasterį,
                tačiau veikiančios replikos pasiliko savo dabartiniuose mazguose
                (dvi <code>swarm-n01</code> ir viena <code>swarm-n03</code>).</p>
            </div>
            <div class="paragraph">
              <p>O štai užklausos į servisą pradėjo veikti jau ir per antrąjį mazgą&#8201;&#8212;&#8201;sugrįžęs
                į klasterį jis įsitraukė į <em>Routing mesh</em> ir <em>Load-balancing</em>                mechanizmą.</p>
            </div>
            <div class="ulist">
              <ul>
                <li>
                  <p>&#8658; Jei gedimas įvyksta <em>Worker</em> mazge, o ne <em>Manager</em>,
                    įtaka paslaugai beveik nejuntama.</p>
                  <div class="paragraph">
                    <p>Paslaugos replikų skaičius atstatomas (sukuriamos trūkstamosios)
                      ilgiausiai po ~ 5 s.</p>
                  </div>
                </li>
              </ul>
            </div>
            <div class="paragraph">
              <p>&#160;</p>
            </div>
            <div style="page-break-after: always;"></div>
          </div>
        </div>
        <div class="sect2">
          <h3 id="_4_naudota_literat_ra">4. Naudota literatūra</h3>
          <div class="sect3 text-left">
            <h4 id="___2">&#160;</h4>
            <div class="paragraph">
              <p><strong><a id="1"></a>[1]</strong> <code>osboxes.org</code>, <a href="https://www.osboxes.org/ubuntu/#ubuntu-20-04-3-info">OSboxes &#160; &gt; &#160; VirtualBox Images &#160; &gt; &#160; Ubuntu &#160; &gt; &#160; Ubuntu 20.04.3 Focal Fossa</a></p>
            </div>
            <div class="paragraph">
              <p><strong><a id="2"></a>[2]</strong> <code>docker.com</code>, <a href="https://docs.docker.com/engine/swarm/swarm-tutorial/">Docker docs &#160; &gt; &#160; Run your app in production &#160; &gt; &#160; Getting started with swarm mode (tutorial)</a></p>
            </div>
            <div class="paragraph">
              <p><strong><a id="3"></a>[3]</strong> <code>katacoda.com</code>, <a href="https://www.katacoda.com/courses/docker-orchestration">O&#8217;Reilly | Katacoda | Learn Docker Orchestration / Swarm Mode using Interactive Browser-Based Scenarios</a></p>
            </div>
            <div class="paragraph">
              <p><strong><a id="4"></a>[4]</strong> <code>katacoda.com</code>, <a href="https://www.katacoda.com/courses/docker-orchestration/getting-started-with-swarm-mode">O&#8217;Reilly | Katacoda | Getting Started With Swarm Mode</a></p>
            </div>
            <div class="paragraph">
              <p><strong><a id="5"></a>[5]</strong> <code>katacoda.com</code>, <a href="https://www.katacoda.com/courses/docker-orchestration/create-overlay-networks">O&#8217;Reilly | Katacoda | Create Overlay Network</a></p>
            </div>
            <div class="paragraph">
              <p><strong><a id="6"></a>[6]</strong> <code>katacoda.com</code>, <a href="https://www.katacoda.com/courses/docker-orchestration/load-balance-service-discovery-swarm-mode">O&#8217;Reilly | Katacoda | Load Balance and Service Discover in Swarm Mode</a></p>
            </div>
            <div class="paragraph">
              <p><strong><a id="7"></a>[7]</strong> <code>katacoda.com</code>, <a href="https://www.katacoda.com/courses/docker-orchestration/rolling-updates-services-swarm-cluster">O&#8217;Reilly | Katacoda | Apply Rolling Updates Across Swarm Cluster</a></p>
            </div>
            <div class="paragraph">
              <p><strong><a id="8"></a>[8]</strong> <code>katacoda.com</code>, <a href="https://www.katacoda.com/courses/docker-orchestration/healthcheck">O&#8217;Reilly | Katacoda | Add Healthcheck for Containers</a></p>
            </div>
            <div class="paragraph">
              <p><strong><a id="9"></a>[9]</strong> <code>katacoda.com</code>, <a href="https://www.katacoda.com/courses/docker-orchestration/deploy-swarm-services-with-compose">O&#8217;Reilly | Katacoda | Deploy Swarm Services with Compose v3</a></p>
            </div>
            <div class="paragraph">
              <p><strong><a id="10"></a>[10]</strong> <code>katacoda.com</code>,
                <a
                  href="https://www.katacoda.com/courses/docker-orchestration/maintenance-mode-for-swarm">O&#8217;Reilly | Katacoda | Enable Maintenance Mode for a Swarm Node</a>
              </p>
            </div>
            <div class="paragraph">
              <p><strong><a id="11"></a>[11]</strong> <code>jayway.com</code>, <a href="https://blog.jayway.com/2015/11/25/simple-clustering-with-docker-swarm-and-nginx/">Simple Clustering with Docker Swarm and Nginx</a></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>

</html>