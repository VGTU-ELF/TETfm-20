Debesų kompiuterija

[.text-center]
=== Laboratorinis darbas nr. 3

[.text-center]
== Susipažinimas su Kubernetes platforma

[.text-left]
=== Darbo tikslas

* Išbandyti `Kubernetes` platformą
* Atlikti pagrindinius veiksmus su `Kubernetes` resursais.

[.text-left]
=== Užduotis

. Puslapyje *https://www.katacoda.com/courses/kubernetes[Learn Kubernetes using Interactive Browser-Based Labs | Katacoda]* susikurkite paskyrą.
. Atlikite šias užduotis:
  * Čia naudosite `Minicube` -- tai įrankis, kuriuo lengva pakeisti `Kubernetes`.
    `Minicube` paleidžia vieno mazgo `Kubernetes` klasterį virtualioje mašinoje nešiojamame kompiuteryje naudotojams, 
    norintiems išbandyti `Kubernetes` arba kurti su ja kasdien:
    - https://www.katacoda.com/courses/kubernetes/launch-single-node-cluster[Launch Single Node Kubernetes Cluster]
  * Šiame scenarijuje sužinosite, kaip naudoti `Kubectl`, 
    kad sukurtumėte ir paleistumėte diegimo, replikavimo valdiklius 
    ir pateiktumėte juos per paslaugas (angl. _Services_) be papildomų `yaml` konfigūracijų.
    Tai leidžia konteinerius greitai startuoti klasteryje.
    - https://www.katacoda.com/courses/kubernetes/kubectl-run-containers[Deploy Containers Using Kubectl]
  * Šiame scenarijuje sužinosite, kaip naudoti `Kubectl`, kad sukurtumėte ir startuotumėte diegimo, replikavimo valdiklius
    ir pateiktumėte juos per paslaugas (angl. _Services_) aprašydami `yaml` apibrėžtis.
    `YAML` aprašo `Kubernetes` objektus.
    - https://www.katacoda.com/courses/kubernetes/creating-kubernetes-yaml-definitions[Deploy Containers Using YAML]
  * Šiame scenarijuje paaiškinama, kaip paleisti paprastą daugiapakopę žiniatinklio programą naudojant `Kubernetes` ir `Docker`:
    - https://www.katacoda.com/courses/kubernetes/guestbook[Deploy Guestbook example on Kubernetes]

Ataskaitos turinys:

  * Aprašyti pasiekti  rezultatai kiekvienoje užduotyje.
  * Failo dydis < 5 MiB, formatas `PDF`.


<<<

== Darbo eiga

=== Scenarijus nr. 1: "*Launch Single Node Kubernetes Cluster*"

  * Žingsnis #1, *startuojame `Minikube`*

    - patikriname versiją:
+
----
$ minikube version
minikube version: v1.8.1
commit: cbda04cf6bbe65e987ae52bb393c10099ab62014
----
image::https://asciinema.org/a/452640.svg[link="https://asciinema.org/a/452640?autoplay=1"]


    - startuojame VM su `Kubernetes` klasteriu
+
----
$ minikube start --wait=false
* minikube v1.8.1 on Ubuntu 18.04
* Using the none driver based on user configuration
* Running on localhost (CPUs=2, Memory=2460MB, Disk=145651MB) ...
* OS release is Ubuntu 18.04.4 LTS
* Preparing Kubernetes v1.17.3 on Docker 19.03.6 ...
  - kubelet.resolv-conf=/run/systemd/resolve/resolv.conf
* Launching Kubernetes ... 
* Enabling addons: default-storageclass, storage-provisioner
* Configuring local host environment ...
* Done! kubectl is now configured to use "minikube"
----
image::https://asciinema.org/a/452643.svg[link="https://asciinema.org/a/452643?autoplay=1"]
+
{nbsp}


  * Žingsnis #2, *klasterio informacija*

    - rodome klasterio būseną:
+
----
$ kubectl cluster-info
Kubernetes master is running at https://172.17.0.86:8443
KubeDNS is running at https://172.17.0.86:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
----
image::https://asciinema.org/a/452671.svg[link="https://asciinema.org/a/452671?autoplay=1"]
+
{nbsp}


    - klasterio nodų sąrašas:
+
----
$ kubectl get nodes
NAME       STATUS     ROLES    AGE   VERSION
minikube   NotReady   master   16s   v1.17.3

$ kubectl get nodes
NAME       STATUS   ROLES    AGE   VERSION
minikube   Ready    master   18s   v1.17.3
----
image::https://asciinema.org/a/452686.svg[link="https://asciinema.org/a/452686?autoplay=1"]
+
{nbsp}


  * Žingsnis #3, *diegiame konteinerius*

    - konteinerio diegimas klasteryje:
+
----
$ kubectl create deployment first-deployment --image=katacoda/docker-http-server
deployment.apps/first-deployment created
----
image::https://asciinema.org/a/452688.svg[link="https://asciinema.org/a/452688?autoplay=1"]
+
{nbsp}


    - tikriname diegimo būseną:
+
----
$ kubectl get pods
NAME                               READY   STATUS              RESTARTS   AGE
first-deployment-666c48b44-92c2z   0/1     ContainerCreating   0          3s

$ kubectl get pods
NAME                               READY   STATUS              RESTARTS   AGE
first-deployment-666c48b44-92c2z   0/1     ContainerCreating   0          4s

$ kubectl get pods
NAME                               READY   STATUS    RESTARTS   AGE
first-deployment-666c48b44-92c2z   1/1     Running   0          5s
----
image::https://asciinema.org/a/452708.svg[link="https://asciinema.org/a/452708?autoplay=1"]
+
{nbsp}


    - paviešiname konteinerį tinkle:
+
----
$ kubectl expose deployment first-deployment --port=80 --type=NodePort
service/first-deployment exposed
----
image::https://asciinema.org/a/452709.svg[link="https://asciinema.org/a/452709?autoplay=1"]
+
{nbsp}


    - susirandame alokuotą TCP-portą ir vykdome HTTP-užklausą:
+
----
$ kubectl get svc first-deployment -o go-template='{{range.spec.ports}}{{if .nodePort}}{{.nodePort}}{{"\n"}}{{end}}{{end}}'
31900

$ export PORT=$(kubectl get svc first-deployment -o go-template='{{range.spec.ports}}{{if .nodePort}}{{.nodePort}}{{"\n"}}{{end}}{{end}}')

$ echo "Accessing host01:$PORT"
Accessing host01:31900

$ curl host01:$PORT
<h1>This request was processed by host: first-deployment-666c48b44-92c2z</h1>
----
image::https://asciinema.org/a/452711.svg[link="https://asciinema.org/a/452711?autoplay=1"]
+
{nbsp}


  * Žingsnis #4, *_Kubernetes Dashboard_ sąsaja (web-UI)*

    - įgaliname _Minicube_ priedą _Dashboard_:
+
----
$ minikube addons enable dashboard
* The 'dashboard' addon is enabled
----
image::https://asciinema.org/a/452714.svg[link="https://asciinema.org/a/452714?autoplay=1"]
+
{nbsp}


    - diegiame _Kubernetes Dashboard_ pagal duotą YAML šabloną:
+
----
$ kubectl apply -f /opt/kubernetes-dashboard.yaml
namespace/kubernetes-dashboard configured
service/kubernetes-dashboard-katacoda created
----
image::https://asciinema.org/a/452718.svg[link="https://asciinema.org/a/452718?autoplay=1"]
+
{nbsp}


    - patikriname šablono turinį:
+
----
$ ls -l /opt/kubernetes-dashboard.yaml
-rw-r--r-- 1 root root 588 Mar  8  2020 /opt/kubernetes-dashboard.yaml

$ cat /opt/kubernetes-dashboard.yaml
apiVersion: v1
kind: Namespace
metadata:
  labels:
    addonmanager.kubernetes.io/mode: Reconcile
    kubernetes.io/minikube-addons: dashboard
  name: kubernetes-dashboard
  selfLink: /api/v1/namespaces/kubernetes-dashboard
spec:
  finalizers:
  - kubernetes
status:
  phase: Active
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: kubernetes-dashboard
  name: kubernetes-dashboard-katacoda
  namespace: kubernetes-dashboard
spec:
  ports:
  - port: 80
    protocol: TCP
    targetPort: 9090
    nodePort: 30000
  selector:
    k8s-app: kubernetes-dashboard
  type: NodePort
----
+
{nbsp}

    - stebime _Dashboard_ konteinerių startą:
+
----
$ kubectl get pods -n kubernetes-dashboard -w
NAME                                         READY   STATUS              RESTARTS   AGE
dashboard-metrics-scraper-7b64584c5c-7x46c   0/1     ContainerCreating   0          1s
kubernetes-dashboard-79d9cd965-7f5pb         0/1     ContainerCreating   0          1s
kubernetes-dashboard-79d9cd965-7f5pb         1/1     Running             0          1s
dashboard-metrics-scraper-7b64584c5c-7x46c   1/1     Running             0          2s
^C
$ 
----
image::https://asciinema.org/a/452725.svg[link="https://asciinema.org/a/452725?autoplay=1"]
+
{nbsp}


    - tikriname web-UI sąsają tiesiogiai:  +
      https://2886795274-30000-cykoria04.environments.katacoda.com/
      
      ** klasterio apžvalga:
+
image::https://user-images.githubusercontent.com/74717106/149772492-a72b5b07-9c09-463d-885a-3c4b81b31ff5.png[]
+
{nbsp}

      ** vardų srities apkrovos apžvalga:
+
image::https://user-images.githubusercontent.com/74717106/149772830-d20b2b96-3d10-432b-9d8a-78e34f04c4bc.png[]
+
{nbsp}

      ** bandomojo diegimo būsena:
+
image::https://user-images.githubusercontent.com/74717106/149774966-f3c803b3-7b9e-489d-9b82-a23e78d2c663.png[]
+
{nbsp}

      ** jo „ankšties“ būsena:
+
image::https://user-images.githubusercontent.com/74717106/149775048-a056fe1e-126f-4371-a9f9-88859feb2f34.png[]
+
{nbsp}

      ** paslaugų būsena, apkrovos balansavimas:
+
image::https://user-images.githubusercontent.com/74717106/149773732-aaf5f1c9-3c28-44e1-8fc6-05c5f44bf709.png[]
---
image::https://user-images.githubusercontent.com/74717106/149773955-ef7a3c7a-6826-4ca5-9723-f40e949fe007.png[]
---
image::https://user-images.githubusercontent.com/74717106/149774143-436458fd-7075-48cd-bcd2-21c7f464f4ba.png[]
+
{nbsp}

      ** vardų srities konfigūracija ir talpinimas:
+
image::https://user-images.githubusercontent.com/74717106/149774278-d7afe893-5549-47e7-a9fa-d3f51b425ab7.png[]
---
image::https://user-images.githubusercontent.com/74717106/149774439-804af510-6baa-4663-8037-56476357ddc9.png[]
+
{nbsp}


  * Reziume:

    - Panaudojau `minikube` bei `kubectl` komandas (jų subkomandas) ir:
    
      . startavau vieno nodo Kubernetes miniklasterį;  +
        (atskiroje VM, pasak gido)
      . patikrinau klasterio būseną: veikiantis;
      . sukūriau konteinerį pagal `katacoda/docker-http-server` atvaizdą;  +
        (tik vaizdo įraše padariau klaidą įterpdamas vieną papildomą raidę: `kataco**n**da`)
      . patikrinau diegimo „ankštį“: ji susikūrė konteinerį ir veikia;
      . paviešinau konteinerinę paslaugą tinkle atskiru `31900/TCP` portu;
      . prisijungiau šiuo portu su `curl` ir patikrinau paslaugos būseną: veikia;
      . įdiegiau ir startavau _Minicube_ priedą -- Web sąsają _Dashboard_
      . bei patikrinau klasterio būseną joje naudodamasis savo naršykle.  +
        (Nuoroda Web prisijungimui pateikė pats _katacoda.com_ gidas)

    - _Dashboard_ interfeisas _Overview_ skiltyje pasirenka `default` vardų sritį (_Namespace_):
      . joje nematyti savo paties „ankščių“ (_Pods_):  +
    `kubernetes-dashboard-79d9cd965-7f5pb`,  +
    `dashboard-metrics-scraper-7b64584c5c-7x46c`
      . jos tampa matomos pasirinkus `All namespaces` vardų sritį.
    

<<<

=== Scenarijus nr. 2: "*Deploy containers using Kubectl*"

  * Žingsnis #1, *TODO*

    - smulkiau:
+
